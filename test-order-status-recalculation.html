<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.ready {
            background: #28a745;
        }
        button.ready:hover {
            background: #218838;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 600px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .payment-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .status-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .status-0 { background: #6c757d; color: white; }
        .status-1 { background: #17a2b8; color: white; }
        .status-2 { background: #28a745; color: white; }
        .status-3 { background: #ffc107; color: black; }
        .status-4 { background: #28a745; color: white; }
        .status-6 { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ÔøΩ –¢–µ—Å—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ Halyk Bank –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ 2 ("–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ").</p>
    </div>

    <div class="payment-info">
        <h3>‚ö†Ô∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö</h3>
        <p><strong>–ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ 2 ("–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ"):</strong></p>
        <ul>
            <li>üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞</li>
            <li>üí≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ Halyk Bank (—á–∞—Å—Ç–∏—á–Ω–æ–µ –∏–ª–∏ –ø–æ–ª–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ)</li>
            <li>üí∞ –°–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è —Å—É–º–º–∞ —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–æ–∫ –∏ –±–æ–Ω—É—Å–æ–≤</li>
            <li>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –ø–æ–ª–µ extra –∑–∞–∫–∞–∑–∞</li>
        </ul>
        <p><strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</strong> –ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å payment_id (—Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ —á–µ—Ä–µ–∑ Halyk Bank API)</p>
    </div>

    <div class="container">
        <h2>üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <div class="form-group">
            <label for="business-token">–¢–æ–∫–µ–Ω –±–∏–∑–Ω–µ—Å–∞:</label>
            <input type="text" id="business-token" placeholder="Business JWT —Ç–æ–∫–µ–Ω" value="">
        </div>
    </div>

    <div class="container">
        <h2>üìã –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h2>
        <div class="grid">
            <div class="form-group">
                <label for="order-id">ID –∑–∞–∫–∞–∑–∞:</label>
                <input type="number" id="order-id" value="1">
            </div>
        </div>
        <button onclick="getOrderStatus()">üîç –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å</button>
    </div>

    <div class="container">
        <h2>üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h2>
        
        <div class="info">
            <strong>–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤:</strong><br>
            0 - –ù–æ–≤—ã–π –∑–∞–∫–∞–∑<br>
            1 - –ü—Ä–∏–Ω—è—Ç –º–∞–≥–∞–∑–∏–Ω–æ–º<br>
            <strong>2 - –ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ (–ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ + –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞!)</strong><br>
            3 - –î–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è<br>
            4 - –î–æ—Å—Ç–∞–≤–ª–µ–Ω<br>
            6 - –û—Ç–º–µ–Ω–µ–Ω
        </div>

        <div class="grid">
            <div class="form-group">
                <label for="status-order-id">ID –∑–∞–∫–∞–∑–∞:</label>
                <input type="number" id="status-order-id" value="1">
            </div>
            <div class="form-group">
                <label for="new-status">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                <select id="new-status">
                    <option value="0">0 - –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</option>
                    <option value="1">1 - –ü—Ä–∏–Ω—è—Ç –º–∞–≥–∞–∑–∏–Ω–æ–º</option>
                    <option value="2" selected>2 - –ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ (—Å –ø–ª–∞—Ç–µ–∂–æ–º!)</option>
                    <option value="3">3 - –î–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è</option>
                    <option value="4">4 - –î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                    <option value="6">6 - –û—Ç–º–µ–Ω–µ–Ω</option>
                </select>
            </div>
        </div>

        <div class="status-buttons">
            <button class="status-btn status-0" onclick="updateStatus(0)">–ù–æ–≤—ã–π</button>
            <button class="status-btn status-1" onclick="updateStatus(1)">–ü—Ä–∏–Ω—è—Ç</button>
            <button class="status-btn status-2" onclick="updateStatus(2)">–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ ‚ö°üí≥</button>
            <button class="status-btn status-3" onclick="updateStatus(3)">–î–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è</button>
            <button class="status-btn status-4" onclick="updateStatus(4)">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</button>
            <button class="status-btn status-6" onclick="updateStatus(6)">–û—Ç–º–µ–Ω–µ–Ω</button>
        </div>

        <br>
        <button onclick="updateOrderStatus()">üíæ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <button class="ready" onclick="testPaymentFlow()">üß™ –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø–ª–∞—Ç–µ–∂–∞</button>
    </div>

    <div class="container">
        <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
        <div id="response" class="response"></div>
    </div>

    <script>
        function showResponse(data, className = 'success') {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent = JSON.stringify(data, null, 2);
            responseDiv.className = `response ${className}`;
        }

        function showInfo(message) {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent = message;
            responseDiv.className = 'response';
        }

        async function getOrderStatus() {
            showInfo('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞...');
            
            const token = document.getElementById('business-token').value;
            const orderId = document.getElementById('order-id').value;
            
            if (!token) {
                showResponse({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω –±–∏–∑–Ω–µ—Å–∞' }, 'error');
                return;
            }
            
            if (!orderId) {
                showResponse({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å ID –∑–∞–∫–∞–∑–∞' }, 'error');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/business/orders/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const order = data.data.order;
                    const statusInfo = {
                        order_id: order.order_id,
                        current_status: order.current_status,
                        cost_summary: order.cost_summary,
                        items_count: order.items_count,
                        payment_info: {
                            has_payment_id: !!order.payment_id,
                            extra_info: order.extra
                        },
                        full_order: data
                    };
                    showResponse(statusInfo, response.ok ? 'success' : 'error');
                    
                    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ID –∑–∞–∫–∞–∑–∞
                    document.getElementById('status-order-id').value = orderId;
                } else {
                    showResponse(data, 'error');
                }
            } catch (error) {
                showResponse({ error: error.message }, 'error');
            }
        }

        async function updateOrderStatus() {
            showInfo('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞...');
            
            const token = document.getElementById('business-token').value;
            const orderId = document.getElementById('status-order-id').value;
            const newStatus = parseInt(document.getElementById('new-status').value);
            
            if (!token) {
                showResponse({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω –±–∏–∑–Ω–µ—Å–∞' }, 'error');
                return;
            }
            
            if (!orderId) {
                showResponse({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å ID –∑–∞–∫–∞–∑–∞' }, 'error');
                return;
            }

            if (newStatus === 2) {
                showInfo('‚ö°üí≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" - —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞ –∏ –ø–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ Halyk Bank...');
            }

            try {
                const response = await fetch(`http://localhost:3000/api/business/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });
                
                const data = await response.json();
                showResponse(data, response.ok ? 'success' : 'error');
                
                if (data.success && newStatus === 2) {
                    setTimeout(() => {
                        showInfo('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω! –ü—Ä–æ–≤–µ—Ä–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∑–∞–∫–∞–∑–∞...');
                        setTimeout(getOrderStatus, 1000);
                    }, 1000);
                }
            } catch (error) {
                showResponse({ error: error.message }, 'error');
            }
        }

        function updateStatus(status) {
            document.getElementById('new-status').value = status;
            updateOrderStatus();
        }

        async function testPaymentFlow() {
            showInfo('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø–ª–∞—Ç–µ–∂–∞...');
            
            const token = document.getElementById('business-token').value;
            const orderId = document.getElementById('order-id').value || 1;
            
            if (!token) {
                showResponse({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω –±–∏–∑–Ω–µ—Å–∞' }, 'error');
                return;
            }
            
            try {
                let testResults = {
                    step1: '–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...',
                    step2: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞...',
                    step3: '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞...',
                    step4: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...'
                };
                
                showResponse(testResults, 'warning');
                
                // –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const initialResponse = await fetch(`http://localhost:3000/api/business/orders/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const initialData = await initialResponse.json();
                if (!initialData.success) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑');
                }
                
                const initialOrder = initialData.data.order;
                testResults.step1 = {
                    status: 'OK',
                    current_status: initialOrder.current_status,
                    cost: initialOrder.cost_summary.total_sum,
                    has_payment_id: !!initialOrder.payment_id
                };
                
                showResponse(testResults, 'warning');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ 1 (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
                if (initialOrder.current_status.status !== 1) {
                    await fetch(`http://localhost:3000/api/business/orders/${orderId}/status`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ status: 1 })
                    });
                }
                
                testResults.step2 = { status: 'OK', message: '–°—Ç–∞—Ç—É—Å "–ü—Ä–∏–Ω—è—Ç" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' };
                showResponse(testResults, 'warning');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ 2 (–ø–µ—Ä–µ—Å—á–µ—Ç + –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
                const confirmResponse = await fetch(`http://localhost:3000/api/business/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: 2 })
                });
                
                const confirmData = await confirmResponse.json();
                testResults.step3 = {
                    status: confirmData.success ? 'OK' : 'ERROR',
                    response: confirmData
                };
                
                showResponse(testResults, 'warning');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const finalResponse = await fetch(`http://localhost:3000/api/business/orders/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const finalData = await finalResponse.json();
                const finalOrder = finalData.data.order;
                
                testResults.step4 = {
                    status: 'COMPLETED',
                    final_status: finalOrder.current_status,
                    final_cost: finalOrder.cost_summary.total_sum,
                    payment_confirmed: finalOrder.extra ? '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ extra' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏',
                    cost_changed: initialOrder.cost_summary.total_sum !== finalOrder.cost_summary.total_sum
                };
                
                testResults.summary = {
                    initial_cost: initialOrder.cost_summary.total_sum,
                    final_cost: finalOrder.cost_summary.total_sum,
                    cost_difference: finalOrder.cost_summary.total_sum - initialOrder.cost_summary.total_sum,
                    payment_processing: finalOrder.extra ? JSON.parse(finalOrder.extra) : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                };
                
                showResponse(testResults, 'success');
                
            } catch (error) {
                showResponse({ 
                    error: '–û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ', 
                    message: error.message,
                    partial_results: testResults 
                }, 'error');
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
        document.getElementById('order-id').addEventListener('input', function() {
            document.getElementById('status-order-id').value = this.value;
        });
    </script>
</body>
</html>
