# ๐ Firebase Push Notifications - Naliv Backend

## ะะฑะทะพั

ะกะธััะตะผะฐ push-ัะฒะตะดะพะผะปะตะฝะธะน ะธะฝัะตะณัะธัะพะฒะฐะฝะฐ ะฒ ะฒะฐั backend ะธ ะณะพัะพะฒะฐ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั. ะฃะฒะตะดะพะผะปะตะฝะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะฟัะฐะฒะปััััั ะฟัะธ ัะพะทะดะฐะฝะธะธ ะธ ะธะทะผะตะฝะตะฝะธะธ ััะฐัััะฐ ะทะฐะบะฐะทะพะฒ.

## โ ะงัะพ ัะถะต ัะดะตะปะฐะฝะพ

### 1. Backend Integration
- โ **NotificationController** - ะฟะพะปะฝัะน ะบะพะฝััะพะปะปะตั ะดะปั ัะฟัะฐะฒะปะตะฝะธั ัะฒะตะดะพะผะปะตะฝะธัะผะธ
- โ **Routes** - API endpoints ะดะปั ะฒัะตั ะพะฟะตัะฐัะธะน ั ัะฒะตะดะพะผะปะตะฝะธัะผะธ  
- โ **Database Schema** - ัะฐะฑะปะธัั ะดะปั FCM ัะพะบะตะฝะพะฒ ะธ ะธััะพัะธะธ ัะฒะตะดะพะผะปะตะฝะธะน
- โ **Order Integration** - ะฐะฒัะพะผะฐัะธัะตัะบะธะต ัะฒะตะดะพะผะปะตะฝะธั ะฟัะธ ัะพะทะดะฐะฝะธะธ/ะธะทะผะตะฝะตะฝะธะธ ะทะฐะบะฐะทะพะฒ
- โ **Firebase Admin SDK** - ะฝะฐัััะพะตะฝะฐ ะธะฝัะตะณัะฐัะธั ั Firebase

### 2. API Endpoints
```
POST   /api/notifications/register-token     - ะะตะณะธัััะฐัะธั FCM ัะพะบะตะฝะฐ
DELETE /api/notifications/remove-token       - ะฃะดะฐะปะตะฝะธะต FCM ัะพะบะตะฝะฐ  
POST   /api/notifications/send-to-user       - ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั
GET    /api/notifications/history            - ะััะพัะธั ัะฒะตะดะพะผะปะตะฝะธะน
PUT    /api/notifications/:id/read           - ะัะผะตัะธัั ะบะฐะบ ะฟัะพัะธัะฐะฝะฝะพะต
POST   /api/notifications/test               - ะขะตััะพะฒะพะต ัะฒะตะดะพะผะปะตะฝะธะต
```

### 3. ะะฒัะพะผะฐัะธัะตัะบะธะต ัะฒะตะดะพะผะปะตะฝะธั
- ๐๏ธ **ะัะธ ัะพะทะดะฐะฝะธะธ ะทะฐะบะฐะทะฐ** - "ะะฐะบะฐะท ะพัะพัะผะปะตะฝ"
- โ **ะัะธ ะฟัะธะฝััะธะธ ะทะฐะบะฐะทะฐ** - "ะะฐะบะฐะท ะฟัะธะฝัั" 
- ๐จโ๐ณ **ะัะธ ะณะพัะพะฒะบะต** - "ะะฐะบะฐะท ะณะพัะพะฒะธััั"
- ๐ **ะัะธ ะณะพัะพะฒะฝะพััะธ** - "ะะฐะบะฐะท ะณะพัะพะฒ"
- ๐ **ะัะธ ะดะพััะฐะฒะบะต** - "ะะฐะบะฐะท ะฒ ะดะพััะฐะฒะบะต"
- ๐ฆ **ะัะธ ะดะพััะฐะฒะบะต** - "ะะฐะบะฐะท ะดะพััะฐะฒะปะตะฝ"
- โ **ะัะธ ะพัะผะตะฝะต** - "ะะฐะบะฐะท ะพัะผะตะฝะตะฝ"

### 4. Database Tables
```sql
-- FCM ัะพะบะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
user_fcm_tokens (id, user_id, fcm_token, device_type, device_id, created_at, updated_at)

-- ะััะพัะธั ัะฒะตะดะพะผะปะตะฝะธะน  
user_notifications (id, user_id, title, body, notification_type, data, read_status, created_at)
```

## ๐ ะงัะพ ะฝัะถะฝะพ ัะดะตะปะฐัั ะดะปั ะทะฐะฟััะบะฐ

### 1. ะะฐัััะพะธัั Firebase (5 ะผะธะฝัั)
```bash
# ะกะปะตะดัะนัะต ะธะฝััััะบัะธะธ ะฒ ัะฐะนะปะต:
cat FIREBASE_SETUP.md
```

### 2. ะะพะฑะฐะฒะธัั ะฟะตัะตะผะตะฝะฝัะต ะฒ .env
```env
# Firebase Configuration (ะทะฐะผะตะฝะธัะต ะฝะฐ ะฒะฐัะธ ะทะฝะฐัะตะฝะธั)
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY_ID=your-private-key-id  
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nyour-private-key\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project-id.iam.gserviceaccount.com
FIREBASE_CLIENT_ID=your-client-id
FIREBASE_CLIENT_X509_CERT_URL=https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-xxxxx%40your-project-id.iam.gserviceaccount.com
```

### 3. ะะตัะตะทะฐะฟัััะธัั ัะตัะฒะตั
```bash
npm run dev
```

ะ ะปะพะณะฐั ะดะพะปะถะฝะพ ะฟะพัะฒะธัััั:
```
โ Firebase Admin SDK ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ
```

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### 1. ะะตะฑ-ะธะฝัะตััะตะนั ะดะปั ัะตััะธัะพะฒะฐะฝะธั
ะัะบัะพะนัะต ัะฐะนะป `test-notifications.html` ะฒ ะฑัะฐัะทะตัะต:
```bash
open test-notifications.html
```

### 2. API ัะตััะธัะพะฒะฐะฝะธะต
```bash
# ะะฐัะตะณะธัััะธัะพะฒะฐัั FCM ัะพะบะตะฝ
curl -X POST http://localhost:3000/api/notifications/register-token \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"fcm_token": "test_token", "device_type": "web"}'

# ะัะฟัะฐะฒะธัั ัะตััะพะฒะพะต ัะฒะตะดะพะผะปะตะฝะธะต
curl -X POST http://localhost:3000/api/notifications/test \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 3. ะะฒัะพะผะฐัะธัะตัะบะพะต ัะตััะธัะพะฒะฐะฝะธะต ัะตัะตะท ะทะฐะบะฐะทั
ะกะพะทะดะฐะนัะต ะทะฐะบะฐะท ัะตัะตะท API - ัะฒะตะดะพะผะปะตะฝะธะต ะพัะฟัะฐะฒะธััั ะฐะฒัะพะผะฐัะธัะตัะบะธ:
```bash
POST /api/orders/create-user-order
```

## ๐ฑ ะะปะธะตะฝััะบะฐั ะธะฝัะตะณัะฐัะธั

### ะะตะฑ-ะฟัะธะปะพะถะตะฝะธะต (Firebase SDK)
```javascript
import { initializeApp } from 'firebase/app';
import { getMessaging, getToken, onMessage } from 'firebase/messaging';

// ะะฝะธัะธะฐะปะธะทะฐัะธั Firebase
const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// ะะพะปััะตะฝะธะต FCM ัะพะบะตะฝะฐ
getToken(messaging, { vapidKey: 'your-vapid-key' }).then((token) => {
  // ะัะฟัะฐะฒะธัั ัะพะบะตะฝ ะฝะฐ ัะตัะฒะตั
  fetch('/api/notifications/register-token', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${userToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ fcm_token: token, device_type: 'web' })
  });
});

// ะะฑัะฐะฑะพัะบะฐ ะฒัะพะดััะธั ัะฒะตะดะพะผะปะตะฝะธะน  
onMessage(messaging, (payload) => {
  console.log('Message received:', payload);
  // ะะพะบะฐะทะฐัั ัะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
});
```

### ะะพะฑะธะปัะฝะพะต ะฟัะธะปะพะถะตะฝะธะต
- **React Native**: `@react-native-firebase/messaging`
- **Flutter**: `firebase_messaging`
- **Native Android**: Firebase SDK for Android
- **Native iOS**: Firebase SDK for iOS

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธ

### ะะพะณะธ ัะตัะฒะตัะฐ
```bash
# ะฃัะฟะตัะฝะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั
โ Firebase Admin SDK ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ

# ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน
ะฃะฒะตะดะพะผะปะตะฝะธะต ะพ ัะพะทะดะฐะฝะธะธ ะทะฐะบะฐะทะฐ 123 ะพัะฟัะฐะฒะปะตะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปั 456
ะฃะฒะตะดะพะผะปะตะฝะธะต ะพ ัะผะตะฝะต ััะฐัััะฐ ะทะฐะบะฐะทะฐ 123 ะพัะฟัะฐะฒะปะตะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปั 456

# ะัะธะฑะบะธ
โ ะัะธะฑะบะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ Firebase: Invalid private key
ะัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ัะฒะตะดะพะผะปะตะฝะธั: No registration tokens found
```

### Firebase Console
ะ [Firebase Console](https://console.firebase.google.com) ะผะพะถะตัะต ะฒะธะดะตัั:
- ะกัะฐัะธััะธะบั ะพัะฟัะฐะฒะปะตะฝะฝัั ัะฒะตะดะพะผะปะตะฝะธะน
- ะัะธะฑะบะธ ะดะพััะฐะฒะบะธ
- ะะบัะธะฒะฝัะต ััััะพะนััะฒะฐ

## ๐ ะะพะบัะผะตะฝัะฐัะธั

- **API Reference**: `NOTIFICATIONS_API.md` - ะฟะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั API
- **Setup Guide**: `FIREBASE_SETUP.md` - ะฟะพัะฐะณะพะฒะฐั ะฝะฐัััะพะนะบะฐ Firebase
- **Test Interface**: `test-notifications.html` - ะฒะตะฑ-ะธะฝัะตััะตะนั ะดะปั ัะตััะธัะพะฒะฐะฝะธั

## ๐ง ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Client App    โ    โ   Naliv Backend  โ    โ   Firebase FCM  โ
โ                 โ    โ                  โ    โ                 โ
โ 1. Register FCM โโโโโถโ 2. Store Token   โ    โ                 โ
โ    Token        โ    โ    in Database   โ    โ                 โ
โ                 โ    โ                  โ    โ                 โ
โ 6. Receive      โโโโโโ 3. Order Created โโโโโถโ 4. Send Push    โ
โ    Notification โ    โ 5. Send via FCM  โ    โ    Notification โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
```

## ๐ Troubleshooting

### ะงะฐัััะต ะฟัะพะฑะปะตะผั:

**1. "Firebase ะฝะต ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ"**
- ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฒ `.env`
- ะฃะฑะตะดะธัะตัั, ััะพ ะฟัะธะฒะฐัะฝัะน ะบะปัั ะฒ ะบะฐะฒััะบะฐั
- ะะตัะตะทะฐะฟัััะธัะต ัะตัะฒะตั

**2. "ะฃะฒะตะดะพะผะปะตะฝะธั ะฝะต ะฟัะธัะพะดัั"**  
- ะัะพะฒะตัััะต, ะทะฐัะตะณะธัััะธัะพะฒะฐะฝ ะปะธ FCM ัะพะบะตะฝ
- ะฃะฑะตะดะธัะตัั, ััะพ ััััะพะนััะฒะพ/ะฑัะฐัะทะตั ัะฐะทัะตัะฐะตั ัะฒะตะดะพะผะปะตะฝะธั
- ะัะพะฒะตัััะต ะปะพะณะธ ัะตัะฒะตัะฐ

**3. "No registration tokens found"**
- ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะทะฐัะตะณะธัััะธัะพะฒะฐะป FCM ัะพะบะตะฝ
- ะขะพะบะตะฝ ัััะฐัะตะป ะธะปะธ ะฝะตะดะตะนััะฒะธัะตะปะตะฝ
- ะะพะปัะทะพะฒะฐัะตะปั ัะดะฐะปะธะป ะฟัะธะปะพะถะตะฝะธะต

### ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:
```bash
# ะัะพะฒะตัะธัั ััะฐััั ัะฒะตะดะพะผะปะตะฝะธะน ะฟะพะปัะทะพะฒะฐัะตะปั  
curl -H "Authorization: Bearer TOKEN" \
  http://localhost:3000/api/notifications/history

# ะะฐัะตะณะธัััะธัะพะฒะฐัั ัะตััะพะฒัะน ัะพะบะตะฝ
curl -X POST -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"fcm_token":"test","device_type":"web"}' \
  http://localhost:3000/api/notifications/register-token
```

---

**๐ ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!** ะะฐัััะพะนัะต Firebase, ะดะพะฑะฐะฒััะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะธ ะฝะฐัะธะฝะฐะนัะต ะพัะฟัะฐะฒะปััั ัะฒะตะดะพะผะปะตะฝะธั ัะฒะพะธะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ.
