<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ–ø–ª–∞—Ç—ã –ø–æ –∫–æ–¥—É –∫–∞—Ä—Ç—ã Halyk</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ –¢–µ—Å—Ç –æ–ø–ª–∞—Ç—ã –ø–æ –∫–æ–¥—É –∫–∞—Ä—Ç—ã Halyk</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ API –¥–ª—è –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ –ø–æ –∫–æ–¥—É –∫–∞—Ä—Ç—ã Halyk (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ)</p>
    </div>

    <div class="container">
        <h2>üõí –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å halyk_id</h2>
        <div class="grid">
            <div class="form-group">
                <label for="jwt-token-create">JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="jwt-token-create" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            
            <div class="form-group">
                <label for="business-id">ID –±–∏–∑–Ω–µ—Å–∞:</label>
                <input type="number" id="business-id" value="2">
            </div>

            <div class="form-group">
                <label for="halyk-id-create">Halyk ID (—Ç–æ–∫–µ–Ω –∫–∞—Ä—Ç—ã):</label>
                <input type="text" id="halyk-id-create" placeholder="abc123def456" value="test-halyk-card-token">
            </div>

            <div class="form-group">
                <label for="street">–£–ª–∏—Ü–∞:</label>
                <input type="text" id="street" value="—É–ª. –¢–µ—Å—Ç–æ–≤–∞—è">
            </div>

            <div class="form-group">
                <label for="house">–î–æ–º:</label>
                <input type="text" id="house" value="10">
            </div>

            <div class="form-group">
                <label for="apartment">–ö–≤–∞—Ä—Ç–∏—Ä–∞:</label>
                <input type="text" id="apartment" value="15">
            </div>

            <div class="form-group">
                <label for="lat">–®–∏—Ä–æ—Ç–∞:</label>
                <input type="number" id="lat" step="any" value="52.271643">
            </div>

            <div class="form-group">
                <label for="lon">–î–æ–ª–≥–æ—Ç–∞:</label>
                <input type="number" id="lon" step="any" value="76.950011">
            </div>

            <div class="form-group full-width">
                <label for="items">–¢–æ–≤–∞—Ä—ã (JSON):</label>
                <textarea id="items" rows="4" placeholder='[{"item_id": 100, "amount": 2}]'>[{"item_id": 100, "amount": 2}]</textarea>
            </div>
        </div>

        <button onclick="createOrderWithHalykId()">üöÄ –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å halyk_id</button>
    </div>

    <div class="container">
        <h2>üí∞ –®–∞–≥ 2: –û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ –∫–æ–¥—É –∫–∞—Ä—Ç—ã Halyk</h2>
        <div class="grid">
            <div class="form-group">
                <label for="jwt-token-pay">JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="jwt-token-pay" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            
            <div class="form-group">
                <label for="order-id">ID –∑–∞–∫–∞–∑–∞:</label>
                <input type="number" id="order-id" placeholder="123">
            </div>

            <div class="form-group full-width">
                <label for="halyk-card-id">–ö–æ–¥ –∫–∞—Ä—Ç—ã Halyk:</label>
                <input type="text" id="halyk-card-id" placeholder="halyk-card-token-123" value="test-halyk-card-token">
            </div>
        </div>

        <button onclick="payWithHalykCard()" class="btn-success">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ –∫–æ–¥—É –∫–∞—Ä—Ç—ã Halyk</button>
    </div>

    <div class="container">
        <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <div id="response-create" class="response"></div>
        <div id="response-pay" class="response"></div>
    </div>

    <script>
        async function createOrderWithHalykId() {
            const responseDiv = document.getElementById('response-create');
            responseDiv.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...';
            responseDiv.className = 'response';

            try {
                const jwtToken = document.getElementById('jwt-token-create').value;
                if (!jwtToken) {
                    throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å JWT —Ç–æ–∫–µ–Ω');
                }

                const items = JSON.parse(document.getElementById('items').value);

                const requestData = {
                    business_id: parseInt(document.getElementById('business-id').value),
                    halyk_id: document.getElementById('halyk-id-create').value,
                    street: document.getElementById('street').value,
                    house: document.getElementById('house').value,
                    apartment: document.getElementById('apartment').value,
                    lat: parseFloat(document.getElementById('lat').value),
                    lon: parseFloat(document.getElementById('lon').value),
                    items: items,
                    delivery_type: "DELIVERY",
                    scheduled_delivery: {
                        type: "ASAP"
                    }
                };

                console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å halyk_id:', requestData);

                const response = await fetch('/api/orders/create-user-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    responseDiv.textContent = `‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!\n\n${JSON.stringify(data, null, 2)}`;
                    responseDiv.className = 'response success';
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã
                    if (data.data && data.data.order_id) {
                        document.getElementById('order-id').value = data.data.order_id;
                        document.getElementById('jwt-token-pay').value = jwtToken;
                    }
                } else {
                    responseDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ${response.status}\n\n${JSON.stringify(data, null, 2)}`;
                    responseDiv.className = 'response error';
                }

            } catch (error) {
                responseDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                responseDiv.className = 'response error';
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        async function payWithHalykCard() {
            const responseDiv = document.getElementById('response-pay');
            responseDiv.textContent = '–ò–Ω–∏—Ü–∏–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã...';
            responseDiv.className = 'response';

            try {
                const jwtToken = document.getElementById('jwt-token-pay').value;
                const orderId = document.getElementById('order-id').value;
                const halykCardId = document.getElementById('halyk-card-id').value;

                if (!jwtToken || !orderId || !halykCardId) {
                    throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø–æ–ª—è');
                }

                const requestData = {
                    order_id: parseInt(orderId),
                    halyk_card_id: halykCardId
                };

                console.log('–û–ø–ª–∞—Ç–∞ –ø–æ –∫–æ–¥—É –∫–∞—Ä—Ç—ã Halyk:', requestData);

                const response = await fetch('/api/payments/pay-with-halyk-card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/html')) {
                        // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ HTML (—Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–ª–∞—Ç–µ–∂–∞), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                        const htmlContent = await response.text();
                        const newWindow = window.open('', '_blank', 'width=800,height=600');
                        newWindow.document.write(htmlContent);
                        newWindow.document.close();
                        
                        responseDiv.textContent = `‚úÖ –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ\n\n–û—Ç–∫—Ä—ã—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–æ –∫–æ–¥—É –∫–∞—Ä—Ç—ã Halyk: ${halykCardId}`;
                        responseDiv.className = 'response success';
                    } else {
                        const data = await response.json();
                        responseDiv.textContent = `‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:\n\n${JSON.stringify(data, null, 2)}`;
                        responseDiv.className = 'response success';
                    }
                } else {
                    const data = await response.json();
                    responseDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ${response.status}\n\n${JSON.stringify(data, null, 2)}`;
                    responseDiv.className = 'response error';
                }

            } catch (error) {
                responseDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                responseDiv.className = 'response error';
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏
        function copyTokenFields() {
            const createToken = document.getElementById('jwt-token-create').value;
            const payToken = document.getElementById('jwt-token-pay').value;
            
            if (createToken && !payToken) {
                document.getElementById('jwt-token-pay').value = createToken;
            }
            if (payToken && !createToken) {
                document.getElementById('jwt-token-create').value = payToken;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.getElementById('jwt-token-create').addEventListener('input', copyTokenFields);
        document.getElementById('jwt-token-pay').addEventListener('input', copyTokenFields);
    </script>
</body>
</html>
