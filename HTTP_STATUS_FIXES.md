# Исправление HTTP статусов в API оплаты

## Проблема

API возвращал HTTP 200 и `success: true` даже если оплата не прошла, что является серьезной ошибкой в REST API дизайне.

## Исправления

### ❌ До исправления:
```json
// HTTP 200 OK (неправильно!)
{
  "success": true,
  "data": {
    "payment_status": "payment_declined"
  }
}
```

### ✅ После исправления:
```json
// HTTP 400 Bad Request (правильно!)
{
  "success": false,
  "error": {
    "message": "Платеж отклонен банком",
    "statusCode": 400,
    "details": {
      "halyk_error": {
        "code": -2,
        "message": "Недостаточно средств"
      }
    }
  }
}
```

## Новые HTTP статусы

| Статус | Ситуация | Пример |
|--------|----------|--------|
| **200** | Оплата успешна | `payment_status: "completed"` |
| **200** | Заказ уже оплачен | `payment_status: "already_paid"` |
| **400** | Платеж отклонен банком | Недостаточно средств, карта заблокирована |
| **400** | Неверные параметры | Отсутствует card_id |
| **401** | Ошибка авторизации | Неверный токен |
| **403** | Доступ запрещен | Чужой заказ |
| **404** | Заказ не найден | Заказ с таким ID не существует |
| **500** | Системная ошибка | Внутренняя ошибка сервера |
| **502** | Ошибка банка | Недоступность банковой системы |

## Детализация ошибок

### Отклоненный платеж (HTTP 400)
```json
{
  "success": false,
  "error": {
    "message": "Платеж отклонен банком",
    "statusCode": 400,
    "timestamp": "2025-08-05T12:00:00Z",
    "details": {
      "halyk_error": {
        "code": 484,
        "message": "Недостаточно средств на карте"
      }
    }
  }
}
```

### Ошибка банка (HTTP 502)
```json
{
  "success": false,
  "error": {
    "message": "Ошибка при обработке платежа в банке",
    "statusCode": 502,
    "timestamp": "2025-08-05T12:00:00Z",
    "details": {
      "halyk_error": {
        "code": 1267,
        "message": "Ошибка связи с карточной системой"
      }
    }
  }
}
```

### Системная ошибка (HTTP 500)
```json
{
  "success": false,
  "error": {
    "message": "Системная ошибка при обработке платежа",
    "statusCode": 500,
    "timestamp": "2025-08-05T12:00:00Z",
    "details": {
      "internal_error": "Database connection failed"
    }
  }
}
```

## Принципы исправления

1. **HTTP 200** - только для успешных операций
2. **success: false** - для всех неуспешных операций
3. **Правильные HTTP статусы** - 4xx для клиентских ошибок, 5xx для серверных
4. **Детальная информация об ошибках** - включая коды банка
5. **Временные метки** - для отладки и логирования

## Обратная совместимость

⚠️ **Внимание**: Это изменение может нарушить работу клиентов, которые проверяют только HTTP статус, а не поле `success`.

Клиенты должны:
- Проверять и HTTP статус, и поле `success`
- Обрабатывать ошибки 4xx и 5xx
- Не полагаться только на HTTP 200

## Тестирование

Обновленный тест интерфейс `test-saved-card-payment-json-v2.html` теперь корректно обрабатывает:
- HTTP 400 - отклоненные платежи
- HTTP 502 - ошибки банка  
- HTTP 500 - системные ошибки
- Детализированные сообщения об ошибках

Это исправление приводит API в соответствие с REST принципами и делает обработку ошибок более предсказуемой.
