<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ Halyk Bank</title>
    <script src="https://epay.homebank.kz/payform/payment-api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        .token-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .old-data {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .new-data {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –†–µ—à–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "–í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã –∏—Å—Ç–µ–∫–ª–æ"</h1>
        
        <div class="alert alert-danger">
            <strong>‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞:</strong><br>
            –í–∞—à —Ç–æ–∫–µ–Ω <code>7IJUZR04ALI6GSOZAQ3DS8</code> –∏—Å—Ç—ë–∫!<br>
            InvoiceId <code>CARD1753625477259025</code> –±–æ–ª—å—à–µ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.
        </div>

        <div class="alert alert-info">
            <strong>üí° –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:</strong><br>
            1. –¢–æ–∫–µ–Ω—ã Halyk Bank –¥–µ–π—Å—Ç–≤—É—é—Ç 20 –º–∏–Ω—É—Ç<br>
            2. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç—ë–∫—à–∏–π —Ç–æ–∫–µ–Ω = –æ—à–∏–±–∫–∞ 400<br>
            3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        </div>

        <div class="old-data">
            <strong>üï∞Ô∏è –ò—Å—Ç—ë–∫—à–∏–µ –¥–∞–Ω–Ω—ã–µ:</strong><br>
            ‚Ä¢ InvoiceId: <code>CARD1753625477259025</code><br>
            ‚Ä¢ Auth: <code>7IJUZR04ALI6GSOZAQ3DS8</code><br>
            ‚Ä¢ –°—Ç–∞—Ç—É—Å: ‚ùå –ò—Å—Ç—ë–∫
        </div>

        <div class="new-data" id="newDataContainer" style="display: none;">
            <strong>‚úÖ –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ:</strong><br>
            ‚Ä¢ InvoiceId: <code id="newInvoiceId">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</code><br>
            ‚Ä¢ Auth: <code id="newAuth">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</code><br>
            ‚Ä¢ –°—Ç–∞—Ç—É—Å: ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="getLatestData()" id="refreshBtn">üîÑ –ü–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button onclick="testOldData()" id="testOldBtn">‚ö†Ô∏è –¢–µ—Å—Ç –∏—Å—Ç—ë–∫—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</button>
            <button onclick="startPayment()" id="startBtn" disabled>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</button>
        </div>

        <div id="statusAlert" class="alert alert-info">
            –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ" –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã
        </div>

        <div class="token-info" id="tokenInfo">
            <strong>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–∞—Ö:</strong><br>
            <div id="tokenDetails">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞...</div>
        </div>
    </div>

    <script>
        let currentPaymentObject = null;
        let freshData = null;

        function updateStatus(message, type = 'info') {
            const statusAlert = document.getElementById('statusAlert');
            statusAlert.className = `alert alert-${type}`;
            statusAlert.innerHTML = message;
        }

        function updateTokenInfo(info) {
            document.getElementById('tokenDetails').innerHTML = info;
        }

        async function getLatestData() {
            try {
                updateStatus('üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö...', 'info');
                document.getElementById('refreshBtn').disabled = true;

                // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π invoiceId
                const response = await fetch('http://localhost:3000/api/payments/test-invoice-generation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 252
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const newInvoiceId = data.data.generatedIds[0]; // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π
                    
                    // –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º auth —Ç–æ–∫–µ–Ω
                    const authResponse = await fetch('http://localhost:3000/api/payments/save-card/test-init', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: 252,
                            amount: 0,
                            invoiceId: newInvoiceId
                        })
                    });

                    const authData = await authResponse.json();
                    
                    if (authData.success) {
                        const newAuth = authData.data.auth;
                        
                        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –ø–ª–∞—Ç–µ–∂–∞
                        freshData = {
                            "invoiceId": newInvoiceId,
                            "backLink": "https://your-app.com/success",
                            "failureBackLink": "https://your-app.com/failure",
                            "postLink": "https://your-backend.com/api/payments/save-card/postlink",
                            "language": "rus",
                            "description": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã - —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ",
                            "accountId": "252",
                            "terminal": "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
                            "amount": 0,
                            "currency": "KZT",
                            "cardSave": true,
                            "paymentType": "cardVerification",
                            "auth": newAuth
                        };

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        document.getElementById('newInvoiceId').textContent = newInvoiceId;
                        document.getElementById('newAuth').textContent = newAuth;
                        document.getElementById('newDataContainer').style.display = 'block';
                        document.getElementById('startBtn').disabled = false;

                        updateStatus('‚úÖ –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞—Ç—ë–∂.', 'success');
                        updateTokenInfo(`
                            <strong>–ù–æ–≤—ã–π InvoiceId:</strong> ${newInvoiceId}<br>
                            <strong>–ù–æ–≤—ã–π Auth:</strong> ${newAuth}<br>
                            <strong>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${new Date().toLocaleTimeString()}<br>
                            <strong>–°—Ç–∞—Ç—É—Å:</strong> ‚úÖ –°–≤–µ–∂–∏–π<br>
                            <strong>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ:</strong> ${new Date(Date.now() + 20*60*1000).toLocaleTimeString()}
                        `);
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å auth —Ç–æ–∫–µ–Ω');
                    }

                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π invoiceId');
                }

            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'danger');
                console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error);
            } finally {
                document.getElementById('refreshBtn').disabled = false;
            }
        }

        async function testOldData() {
            updateStatus('‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å—Ç—ë–∫—à–∏–µ –¥–∞–Ω–Ω—ã–µ (–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞)...', 'warning');
            
            const oldPaymentObject = {
                "invoiceId": "CARD1753625477259025",
                "backLink": "https://your-app.com/success",
                "failureBackLink": "https://your-app.com/failure",
                "postLink": "https://your-backend.com/api/payments/save-card/postlink",
                "language": "rus",
                "description": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã",
                "accountId": "252",
                "terminal": "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
                "amount": 0,
                "currency": "KZT",
                "cardSave": true,
                "paymentType": "cardVerification",
                "auth": "7IJUZR04ALI6GSOZAQ3DS8"
            };

            setupCallbacks();
            console.log('–¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å—Ç—ë–∫—à–∏–µ –¥–∞–Ω–Ω—ã–µ:', oldPaymentObject);
            halyk.cardverification(oldPaymentObject);
        }

        function startPayment() {
            if (!freshData) {
                updateStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ!', 'danger');
                return;
            }

            updateStatus('üöÄ –ó–∞–ø—É—Å–∫ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...', 'info');
            setupCallbacks();
            
            console.log('–ó–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:', freshData);
            updateTokenInfo(document.getElementById('tokenDetails').innerHTML + '<br><br><strong>üöÄ –°—Ç–∞—Ç—É—Å:</strong> –ó–∞–ø—É—â–µ–Ω –ø–ª–∞—Ç—ë–∂...');
            
            halyk.cardverification(freshData);
        }

        function setupCallbacks() {
            window.halyk_success = function(data) {
                console.log('‚úÖ –£—Å–ø–µ—Ö:', data);
                updateStatus('üéâ –ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!', 'success');
                updateTokenInfo(document.getElementById('tokenDetails').innerHTML + '<br><br><strong>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –£—Å–ø–µ—Ö!');
            };

            window.halyk_failure = function(error) {
                console.log('‚ùå –û—à–∏–±–∫–∞:', error);
                
                if (error.message && error.message.includes('–∏—Å—Ç–µ–∫–ª–æ')) {
                    updateStatus('‚è∞ –û–±–Ω–∞—Ä—É–∂–µ–Ω timeout - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!', 'warning');
                    setTimeout(() => {
                        getLatestData();
                    }, 2000);
                } else {
                    updateStatus(`‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'danger');
                }
                
                updateTokenInfo(document.getElementById('tokenDetails').innerHTML + `<br><br><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            };

            window.halyk_cancelled = function() {
                console.log('‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                updateStatus('‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
            };
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üìã –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.', 'info');
            updateTokenInfo(`
                <strong>üï∞Ô∏è –ò—Å—Ç—ë–∫—à–∏–µ –¥–∞–Ω–Ω—ã–µ:</strong><br>
                InvoiceId: CARD1753625477259025<br>
                Auth: 7IJUZR04ALI6GSOZAQ3DS8<br>
                –°—Ç–∞—Ç—É—Å: ‚ùå –ò—Å—Ç—ë–∫<br>
                <br>
                <em>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ" –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</em>
            `);
        });
    </script>
</body>
</html>
