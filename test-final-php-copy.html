<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ - –¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è PHP</title>
    <script src="https://epay.homebank.kz/payform/payment-api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        .php-code {
            background-color: #2d3748;
            color: #e2e8f0;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .php-side, .js-side {
            padding: 15px;
            border-radius: 5px;
        }
        .php-side {
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
        .js-side {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ - –¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è PHP</h1>
        
        <div class="alert alert-info">
            <strong>üìã –¶–µ–ª—å:</strong> –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ç–æ—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ —Ä–∞–±–æ—á–µ–≥–æ PHP –∫–æ–¥–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è timeout
        </div>

        <div class="comparison">
            <div class="php-side">
                <h3>üêò PHP –ö–æ–¥ (—Ä–∞–±–æ—á–∏–π)</h3>
                <div class="php-code">
var createPaymentObject = function(auth, invoiceId, amount) {
    var paymentObject = {
        invoiceId: invoiceId,
        backLink: "https://chorenn.naliv.kz/success",
        failureBackLink: "https://chorenn.naliv.kz/failure",
        postLink: "https://chorenn.naliv.kz/api/payment.php",
        language: "rus",
        description: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã",
        accountId: "'.$client_id.'",
        terminal: "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
        amount: amount,
        currency: "USD", // ‚úÖ –ö–õ–Æ–ß!
        cardSave: true,
        paymentType: "cardVerification"
    };
    paymentObject.auth = auth;
    return paymentObject;
};

halyk.cardverification(createPaymentObject(auth, invoiceId, amount));
                </div>
            </div>

            <div class="js-side">
                <h3>üü® JavaScript (–Ω–∞—à–∞ –∫–æ–ø–∏—è)</h3>
                <div class="php-code" style="background-color: #1e3a5f;">
var createPaymentObject = function(auth, invoiceId, amount) {
    var paymentObject = {
        invoiceId: invoiceId,
        backLink: "https://chorenn.naliv.kz/success",
        failureBackLink: "https://chorenn.naliv.kz/failure",
        postLink: "https://chorenn.naliv.kz/api/payment.php",
        language: "rus",
        description: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã",
        accountId: "252",
        terminal: "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
        amount: amount,
        currency: "USD", // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û!
        cardSave: true,
        paymentType: "cardVerification"
    };
    paymentObject.auth = auth;
    return paymentObject;
};

halyk.cardverification(createPaymentObject(auth, invoiceId, amount));
                </div>
            </div>
        </div>

        <div class="alert alert-success">
            <strong>‚úÖ –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</strong><br>
            ‚Ä¢ –í–∞–ª—é—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ —Å KZT –Ω–∞ <strong>USD</strong><br>
            ‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ PHP<br>
            ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è <code>halyk.cardverification()</code><br>
            ‚Ä¢ –í—Å–µ URL –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–∞–±–æ—á–µ–º—É –∫–æ–¥—É
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="testExactPHPCopy()" id="testBtn">üöÄ –¢–ï–°–¢: –¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è PHP</button>
            <button onclick="compareCurrencies()" id="compareBtn">‚öñÔ∏è –°—Ä–∞–≤–Ω–∏—Ç—å –≤–∞–ª—é—Ç—ã</button>
            <button onclick="autoTest()" id="autoTestBtn">üîÑ –ê–≤—Ç–æ—Ç–µ—Å—Ç –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫</button>
        </div>

        <div id="statusAlert" class="alert alert-info">
            –ì–æ—Ç–æ–≤ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Ç–µ—Å—Ç—É —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        </div>

        <div id="resultContainer" style="display: none;">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        let testResults = [];
        let autoTestInterval = null;

        function updateStatus(message, type = 'info') {
            const statusAlert = document.getElementById('statusAlert');
            statusAlert.className = `alert alert-${type}`;
            statusAlert.innerHTML = message;
        }

        function addResult(test, currency, status, error = null) {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push({
                timestamp,
                test,
                currency,
                status,
                error
            });

            displayResults();
        }

        function displayResults() {
            const container = document.getElementById('resultContainer');
            const resultsDiv = document.getElementById('testResults');
            
            const html = testResults.map(result => {
                const statusClass = result.status === 'SUCCESS' ? 'alert-success' : 
                                  result.status === 'TIMEOUT' ? 'alert-danger' : 'alert-warning';
                
                return `
                    <div class="alert ${statusClass}" style="margin: 5px 0; padding: 10px;">
                        <strong>[${result.timestamp}]</strong> ${result.test}<br>
                        <strong>–í–∞–ª—é—Ç–∞:</strong> ${result.currency} ‚Üí <strong>${result.status}</strong>
                        ${result.error ? `<br><em>–û—à–∏–±–∫–∞: ${result.error}</em>` : ''}
                    </div>
                `;
            }).reverse().join('');

            resultsDiv.innerHTML = html;
            container.style.display = 'block';
        }

        function generateUniqueInvoiceId() {
            const timestamp = Date.now();
            const userId = 252;
            const random = Math.floor(Math.random() * 100);
            return `CARD${timestamp}${userId.toString().padStart(3, '0')}${random}`;
        }

        async function getFreshAuth(invoiceId) {
            try {
                const response = await fetch('http://localhost:3000/api/payments/save-card/test-init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 252,
                        amount: 0,
                        invoiceId: invoiceId
                    })
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å auth —Ç–æ–∫–µ–Ω');
                }

                return data.data.auth;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è auth:', error);
                throw error;
            }
        }

        async function testExactPHPCopy() {
            try {
                document.getElementById('testBtn').disabled = true;
                updateStatus('üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–Ω–æ–π –∫–æ–ø–∏–∏ PHP –∫–æ–¥–∞...', 'info');

                const invoiceId = generateUniqueInvoiceId();
                const auth = await getFreshAuth(invoiceId);

                // ‚úÖ –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø PHP –ö–û–î–ê
                var createPaymentObject = function(auth, invoiceId, amount) {
                    var paymentObject = {
                        invoiceId: invoiceId,
                        backLink: "https://chorenn.naliv.kz/success",
                        failureBackLink: "https://chorenn.naliv.kz/failure",
                        postLink: "https://chorenn.naliv.kz/api/payment.php",
                        language: "rus",
                        description: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã",
                        accountId: "252",
                        terminal: "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
                        amount: amount,
                        currency: "USD", // ‚úÖ –ö–ê–ö –í PHP!
                        cardSave: true,
                        paymentType: "cardVerification"
                    };
                    paymentObject.auth = auth;
                    return paymentObject;
                };

                const paymentObject = createPaymentObject(auth, invoiceId, 0);

                setupCallbacks(invoiceId, 'PHP_COPY', 'USD');
                console.log('üéØ –ó–∞–ø—É—Å–∫ —Ç–æ—á–Ω–æ–π –∫–æ–ø–∏–∏ PHP:', paymentObject);
                
                updateStatus('‚úÖ –û–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –ø–æ PHP –æ–±—Ä–∞–∑—Ü—É. –ó–∞–ø—É—Å–∫ –ø–ª–∞—Ç–µ–∂–∞...', 'success');
                halyk.cardverification(paymentObject);

            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞ PHP –∫–æ–ø–∏–∏: ${error.message}`, 'danger');
                addResult('PHP_COPY', 'USD', 'ERROR', error.message);
            } finally {
                document.getElementById('testBtn').disabled = false;
            }
        }

        async function compareCurrencies() {
            updateStatus('‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞–ª—é—Ç USD vs KZT...', 'info');
            
            // –¢–µ—Å—Ç —Å USD (–∫–∞–∫ –≤ PHP)
            setTimeout(async () => {
                try {
                    const invoiceId1 = generateUniqueInvoiceId();
                    const auth1 = await getFreshAuth(invoiceId1);
                    
                    const usdObject = {
                        invoiceId: invoiceId1,
                        backLink: "https://chorenn.naliv.kz/success",
                        failureBackLink: "https://chorenn.naliv.kz/failure",
                        postLink: "https://chorenn.naliv.kz/api/payment.php",
                        language: "rus",
                        description: "–¢–µ—Å—Ç USD",
                        accountId: "252",
                        terminal: "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
                        amount: 0,
                        currency: "USD",
                        cardSave: true,
                        paymentType: "cardVerification",
                        auth: auth1
                    };

                    setupCallbacks(invoiceId1, 'COMPARE_USD', 'USD');
                    halyk.cardverification(usdObject);
                } catch (error) {
                    addResult('COMPARE_USD', 'USD', 'ERROR', error.message);
                }
            }, 1000);

            // –¢–µ—Å—Ç —Å KZT
            setTimeout(async () => {
                try {
                    const invoiceId2 = generateUniqueInvoiceId();
                    const auth2 = await getFreshAuth(invoiceId2);
                    
                    const kztObject = {
                        invoiceId: invoiceId2,
                        backLink: "https://chorenn.naliv.kz/success",
                        failureBackLink: "https://chorenn.naliv.kz/failure",
                        postLink: "https://chorenn.naliv.kz/api/payment.php",
                        language: "rus",
                        description: "–¢–µ—Å—Ç KZT",
                        accountId: "252",
                        terminal: "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
                        amount: 0,
                        currency: "KZT",
                        cardSave: true,
                        paymentType: "cardVerification",
                        auth: auth2
                    };

                    setupCallbacks(invoiceId2, 'COMPARE_KZT', 'KZT');
                    halyk.cardverification(kztObject);
                } catch (error) {
                    addResult('COMPARE_KZT', 'KZT', 'ERROR', error.message);
                }
            }, 3000);
        }

        function autoTest() {
            if (autoTestInterval) {
                clearInterval(autoTestInterval);
                autoTestInterval = null;
                document.getElementById('autoTestBtn').textContent = 'üîÑ –ê–≤—Ç–æ—Ç–µ—Å—Ç –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫';
                return;
            }

            document.getElementById('autoTestBtn').textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ—Ç–µ—Å—Ç';
            updateStatus('üîÑ –ê–≤—Ç–æ—Ç–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω: PHP –∫–æ–ø–∏—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥', 'info');
            
            autoTestInterval = setInterval(() => {
                testExactPHPCopy();
            }, 10000);
        }

        function setupCallbacks(invoiceId, testName, currency) {
            window.halyk_success = function(data) {
                console.log('‚úÖ –£—Å–ø–µ—Ö:', data);
                updateStatus(`üéâ –£–°–ü–ï–• —Å ${currency}! Timeout –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!`, 'success');
                addResult(testName, currency, 'SUCCESS');
                
                if (currency === 'USD') {
                    updateStatus('üéØ –†–ï–®–ï–ù–ò–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: USD –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç timeout!', 'success');
                }
            };

            window.halyk_failure = function(error) {
                console.log('‚ùå –û—à–∏–±–∫–∞:', error);
                
                const errorMsg = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                
                if (errorMsg.includes('–∏—Å—Ç–µ–∫–ª–æ') || errorMsg.includes('timeout')) {
                    updateStatus(`‚è∞ Timeout —Å ${currency}`, 'danger');
                    addResult(testName, currency, 'TIMEOUT', errorMsg);
                    
                    if (currency === 'KZT') {
                        updateStatus('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: KZT –≤—ã–∑—ã–≤–∞–µ—Ç timeout, USD –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç!', 'warning');
                    } else {
                        updateStatus('‚ùå Timeout –¥–∞–∂–µ —Å USD. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.', 'danger');
                    }
                } else {
                    updateStatus(`‚ùå –û—à–∏–±–∫–∞ ${currency}: ${errorMsg}`, 'danger');
                    addResult(testName, currency, 'ERROR', errorMsg);
                }
            };

            window.halyk_cancelled = function() {
                console.log('‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                updateStatus('‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'info');
                addResult(testName, currency, 'CANCELLED');
            };
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üìã –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ "–¢–ï–°–¢: –¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è PHP"', 'info');
        });
    </script>
</body>
</html>
