# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –û—à–∏–±–∫–∞ "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ—è–≤–ª—è–ª–∞—Å—å –æ—à–∏–±–∫–∞ "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è", —Ö–æ—Ç—è –∫–æ–¥ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º.

**–õ–æ–≥–∏:**
```
[verifyCode] Code validation result: false
Error 401: –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

–ü–æ–ª–µ `onetime_code` –≤ —Ç–∞–±–ª–∏—Ü–µ `phone_number_verify` –∏–º–µ–ª–æ —Ç–∏–ø `VARCHAR(10)`, –Ω–æ bcrypt —Ö–µ—à –∑–∞–Ω–∏–º–∞–µ—Ç **60 —Å–∏–º–≤–æ–ª–æ–≤**.

–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ö–µ—à–∞ –≤ –ë–î –æ–Ω –æ–±—Ä–µ–∑–∞–ª—Å—è –¥–æ 10 —Å–∏–º–≤–æ–ª–æ–≤:
- –ü–æ–ª–Ω—ã–π —Ö–µ—à: `$2b$10$PxV.../60 —Å–∏–º–≤–æ–ª–æ–≤/`
- –°–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å: `$2b$10$PxV` (—Ç–æ–ª—å–∫–æ 10 —Å–∏–º–≤–æ–ª–æ–≤)

–ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ `bcrypt.compare()` –Ω–µ –º–æ–≥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã–π –∫–æ–¥ —Å –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–º —Ö–µ—à–æ–º.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ Prisma

**–ë—ã–ª–æ:**
```prisma
model phone_number_verify {
  onetime_code    String   @db.VarChar(10)  ‚ùå
}
```

**–°—Ç–∞–ª–æ:**
```prisma
model phone_number_verify {
  onetime_code    String   @db.VarChar(255)  ‚úÖ
}
```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
ALTER TABLE phone_number_verify 
MODIFY COLUMN onetime_code VARCHAR(255) NOT NULL;
```

–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π:
```bash
npx prisma db push
```

### 3. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–º–∏ —Ö–µ—à–∞–º–∏ (–¥–ª–∏–Ω–∞ < 50 —Å–∏–º–≤–æ–ª–æ–≤) –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å:

```sql
DELETE FROM phone_number_verify WHERE LENGTH(onetime_code) < 50;
```

–ò–ª–∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ:
```sql
DELETE FROM phone_number_verify;
```

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥:**
   ```bash
   curl -X POST "http://localhost:3000/api/auth/send-code" \
     -H "Content-Type: application/json" \
     -d '{"phone_number": "+77760986949"}'
   ```

2. **–í –ª–æ–≥–∞—Ö —É–≤–∏–¥–∏—Ç–µ:**
   ```
   [sendCode] Generated code: { code: '123456', ... }
   [sendCode] Hashed code: { hashedCode: '$2b$10$...', hashedLength: 60 }
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥:**
   ```bash
   curl -X POST "http://localhost:3000/api/auth/verify-code" \
     -H "Content-Type: application/json" \
     -d '{"phone_number": "+77760986949", "onetime_code": "123456"}'
   ```

4. **–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
   ```
   [verifyCode] Code validation result: true  ‚úÖ
   ```

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Bcrypt —Ö–µ—à —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
$2b$10$abcdefghijklmnopqrstuvwxyz1234567890ABCDEFGHIJKLM
|  |  |                                                    |
|  |  |                                                    ‚îî‚îÄ –•–µ—à (31 —Å–∏–º–≤–æ–ª)
|  |  ‚îî‚îÄ –°–æ–ª—å (22 —Å–∏–º–≤–æ–ª–∞)
|  ‚îî‚îÄ Cost factor (10)
‚îî‚îÄ –ê–ª–≥–æ—Ä–∏—Ç–º ($2b$ = bcrypt)

–ò—Ç–æ–≥–æ: 60 —Å–∏–º–≤–æ–ª–æ–≤
```

### –ü–æ—á–µ–º—É VARCHAR(255)?
- Bcrypt —Ö–µ—à: 60 —Å–∏–º–≤–æ–ª–æ–≤
- –ó–∞–ø–∞—Å –Ω–∞ –±—É–¥—É—â–µ–µ (–¥—Ä—É–≥–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è)
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ö–µ—à–µ–π

## üöÄ –°—Ç–∞—Ç—É—Å

‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
- –°—Ö–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- –ö–æ–¥ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω
- –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è production

1. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ production –ë–î:
   ```bash
   npx prisma db push
   ```

2. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2025-12-11
