<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Payment Processing Complete</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 20px; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .output { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</h1>

    <!-- –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –æ–ø–ª–∞—Ç–æ–π -->
    <div class="test-section">
        <h3>1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –æ–ø–ª–∞—Ç–æ–π</h3>
        <button onclick="testCreateOrderWithPayment()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –æ–ø–ª–∞—Ç–æ–π</button>
        <button onclick="testCreateOrderPickup()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ (—Å–∞–º–æ–≤—ã–≤–æ–∑)</button>
        <div class="output" id="orderOutput"></div>
    </div>

    <!-- –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã -->
    <div class="test-section">
        <h3>2. –¢–µ—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã</h3>
        <input type="text" id="successInvoiceId" placeholder="Invoice ID" value="CARD1753627123456789">
        <input type="text" id="successAmount" placeholder="–°—É–º–º–∞" value="2500">
        <button onclick="testPaymentSuccess()">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞</button>
        <div class="output" id="successOutput"></div>
    </div>

    <!-- –¢–µ—Å—Ç –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã -->
    <div class="test-section">
        <h3>3. –¢–µ—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã</h3>
        <input type="text" id="failureInvoiceId" placeholder="Invoice ID" value="CARD1753627123456789">
        <input type="text" id="failureError" placeholder="–ö–æ–¥ –æ—à–∏–±–∫–∏" value="INSUFFICIENT_FUNDS">
        <input type="text" id="failureMessage" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ" value="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç–µ">
        <button onclick="testPaymentFailure()">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—à–∏–±–∫–∏</button>
        <div class="output" id="failureOutput"></div>
    </div>

    <!-- –¢–µ—Å—Ç webhook -->
    <div class="test-section">
        <h3>4. –¢–µ—Å—Ç webhook –æ—Ç Halyk Bank</h3>
        <input type="text" id="webhookInvoiceId" placeholder="Invoice ID" value="CARD1753627123456789">
        <select id="webhookStatus">
            <option value="PAID">–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (PAID)</option>
            <option value="FAILED">–ù–µ—É–¥–∞—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (FAILED)</option>
        </select>
        <button onclick="testWebhook()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å webhook</button>
        <div class="output" id="webhookOutput"></div>
    </div>

    <!-- –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ -->
    <div class="test-section">
        <h3>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞</h3>
        <input type="number" id="statusOrderId" placeholder="ID –∑–∞–∫–∞–∑–∞" value="1">
        <button onclick="testOrderStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <div class="output" id="statusOutput"></div>
    </div>

    <!-- –û–±—â–∏–π –ª–æ–≥ -->
    <div class="test-section">
        <h3>üìã –û–±—â–∏–π –ª–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        <div class="output" id="generalLog"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyNTIsInVzZXJuYW1lIjoic2hydiIsImVtYWlsIjoic2hydk5hbGl2QGdtYWlsLmNvbSIsImlhdCI6MTczNzk5MTA1NSwiZXhwIjoxNzM3OTk0NjU1fQ.LhCYSfhcLGIeHGU5w_fwM3j0bVrGM-IHhzK6EWuP0QY';

        function log(message, type = 'info', outputId = 'generalLog') {
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            const logEntry = `<p class="${className}">[${timestamp}] ${message}</p>`;
            output.innerHTML += logEntry;
            
            // –î—É–±–ª–∏—Ä—É–µ–º –≤ –æ–±—â–∏–π –ª–æ–≥
            if (outputId !== 'generalLog') {
                document.getElementById('generalLog').innerHTML += logEntry;
            }
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('generalLog').innerHTML = '';
        }

        // 1. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –æ–ø–ª–∞—Ç–æ–π
        async function testCreateOrderWithPayment() {
            try {
                log('üõí –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π...', 'info', 'orderOutput');

                const orderData = {
                    business_id: 1,
                    address_id: 42,
                    delivery_type: 'DELIVERY',
                    items: [
                        { item_id: 1, amount: 2, options: [] },
                        { item_id: 2, amount: 1, options: [] }
                    ],
                    payment_method: 'card'
                };

                const response = await fetch(`${API_BASE_URL}/api/payments/create-order-with-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.headers.get('content-type')?.includes('text/html')) {
                    log('‚úÖ –ü–æ–ª—É—á–µ–Ω HTML –æ—Ç–≤–µ—Ç —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º–æ–π!', 'success', 'orderOutput');
                    const html = await response.text();
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ HTML
                    const orderMatch = html.match(/–ó–∞–∫–∞–∑ ‚Ññ(ORDER-[^"]+)/);
                    const amountMatch = html.match(/–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: (\d+(?:\.\d+)?)/);
                    
                    if (orderMatch) {
                        log(`üì¶ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω: ${orderMatch[1]}`, 'success', 'orderOutput');
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤
                        window.testOrderUuid = orderMatch[1];
                    }
                    if (amountMatch) {
                        log(`üí∞ –°—É–º–º–∞: ${amountMatch[1]} ‚Ç∏`, 'info', 'orderOutput');
                    }

                    // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Ñ–æ—Ä–º—É
                    if (confirm('–û—Ç–∫—Ä—ã—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Ñ–æ—Ä–º—É –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ?')) {
                        const paymentWindow = window.open('', '_blank');
                        paymentWindow.document.write(html);
                        log('üöÄ –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ', 'success', 'orderOutput');
                    }
                } else {
                    const result = await response.json();
                    log('‚ùå –û—à–∏–±–∫–∞: ' + JSON.stringify(result, null, 2), 'error', 'orderOutput');
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + error.message, 'error', 'orderOutput');
            }
        }

        // –¢–µ—Å—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
        async function testCreateOrderPickup() {
            try {
                log('üè™ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å —Å–∞–º–æ–≤—ã–≤–æ–∑–æ–º...', 'info', 'orderOutput');

                const orderData = {
                    business_id: 1,
                    delivery_type: 'PICKUP',
                    items: [
                        { item_id: 1, amount: 1, options: [] }
                    ],
                    payment_method: 'card'
                };

                const response = await fetch(`${API_BASE_URL}/api/payments/create-order-with-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.headers.get('content-type')?.includes('text/html')) {
                    log('‚úÖ –ó–∞–∫–∞–∑ —Å–∞–º–æ–≤—ã–≤–æ–∑ —Å–æ–∑–¥–∞–Ω!', 'success', 'orderOutput');
                    const html = await response.text();
                    const orderMatch = html.match(/–ó–∞–∫–∞–∑ ‚Ññ(ORDER-[^"]+)/);
                    if (orderMatch) {
                        log(`üì¶ –ó–∞–∫–∞–∑ —Å–∞–º–æ–≤—ã–≤–æ–∑: ${orderMatch[1]}`, 'success', 'orderOutput');
                    }
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑: ' + error.message, 'error', 'orderOutput');
            }
        }

        // 2. –¢–µ—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        function testPaymentSuccess() {
            const invoiceId = document.getElementById('successInvoiceId').value;
            const amount = document.getElementById('successAmount').value;
            
            log(`üéâ –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –¥–ª—è ${invoiceId}`, 'info', 'successOutput');
            
            const url = `${API_BASE_URL}/api/payments/success?invoiceId=${invoiceId}&amount=${amount}&cardMask=4455**1234`;
            window.open(url, '_blank');
            
            log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ', 'success', 'successOutput');
        }

        // 3. –¢–µ—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        function testPaymentFailure() {
            const invoiceId = document.getElementById('failureInvoiceId').value;
            const error = document.getElementById('failureError').value;
            const errorMessage = document.getElementById('failureMessage').value;
            
            log(`‚ùå –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—à–∏–±–∫–∏ –æ–ø–ª–∞—Ç—ã –¥–ª—è ${invoiceId}`, 'info', 'failureOutput');
            
            const url = `${API_BASE_URL}/api/payments/failure?invoiceId=${invoiceId}&error=${error}&errorMessage=${encodeURIComponent(errorMessage)}`;
            window.open(url, '_blank');
            
            log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ', 'success', 'failureOutput');
        }

        // 4. –¢–µ—Å—Ç webhook
        async function testWebhook() {
            try {
                const invoiceId = document.getElementById('webhookInvoiceId').value;
                const status = document.getElementById('webhookStatus').value;
                
                log(`üìû –û—Ç–ø—Ä–∞–≤–∫–∞ webhook –¥–ª—è ${invoiceId} —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ${status}`, 'info', 'webhookOutput');

                const webhookData = {
                    invoiceId: invoiceId,
                    status: status,
                    paymentStatus: status === 'PAID' ? 'SUCCESS' : 'FAILED',
                    amount: '2500',
                    currency: 'KZT',
                    cardMask: '4455**1234',
                    transactionId: 'TXN' + Date.now(),
                    timestamp: new Date().toISOString()
                };

                if (status === 'FAILED') {
                    webhookData.errorCode = 'INSUFFICIENT_FUNDS';
                    webhookData.errorMessage = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç–µ';
                }

                const response = await fetch(`${API_BASE_URL}/api/payments/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });

                const result = await response.json();
                log('‚úÖ Webhook –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ' + JSON.stringify(result, null, 2), 'success', 'webhookOutput');

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ webhook: ' + error.message, 'error', 'webhookOutput');
            }
        }

        // 5. –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
        async function testOrderStatus() {
            try {
                const orderId = document.getElementById('statusOrderId').value;
                
                log(`üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ ${orderId}`, 'info', 'statusOutput');

                const response = await fetch(`${API_BASE_URL}/api/payments/order-payment-status/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    log('‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–ª—É—á–µ–Ω: ' + JSON.stringify(result.data, null, 2), 'success', 'statusOutput');
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + result.message, 'error', 'statusOutput');
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'error', 'statusOutput');
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–∫–æ–Ω
        window.addEventListener('message', function(event) {
            if (event.data.type === 'payment_success') {
                log(`üéâ –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ: ${event.data.invoiceId}`, 'success');
            } else if (event.data.type === 'payment_failure') {
                log(`‚ùå –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ–ø–ª–∞—Ç—ã: ${event.data.error}`, 'error');
            } else if (event.data.type === 'payment_retry') {
                log(`üîÑ –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ–ø–ª–∞—Ç—É: ${event.data.invoiceId}`, 'info');
            }
        });

        log('üß™ –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
    </script>
</body>
</html>
