# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ API –∞–¥—Ä–µ—Å–æ–≤ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π

## –ü—Ä–æ–±–ª–µ–º–∞
–ó–∞–ø—Ä–æ—Å `/api/addresses/user/with-delivery` –±—ã–ª –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –∏–∑-–∑–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –ú–µ—Ç–æ–¥ `getUserAddressesWithDelivery` –≤—ã–ø–æ–ª–Ω—è–ª –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –ø–æ –æ—á–µ—Ä–µ–¥–∏ –≤ —Ü–∏–∫–ª–µ `for`
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –∑–∞–Ω–æ–≤–æ, –¥–∞–∂–µ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π**: –ú–µ—Ç–æ–¥ –º–æ–≥ –∑–∞–≥—Ä—É–∂–∞—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**: –ù–µ –±—ã–ª–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
**–î–æ:**
```typescript
for (const address of addresses) {
  const deliveryResult = await DeliveryController.calculateDeliveryZone({...});
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}
```

**–ü–æ—Å–ª–µ:**
```typescript
const addressesWithDeliveryPromises = addresses.map(async (address) => {
  const deliveryResult = await DeliveryController.calculateDeliveryZone({...});
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
});
const addressesWithDelivery = await Promise.all(addressesWithDeliveryPromises);
```

### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
```typescript
// –ö–µ—à –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
const deliveryCache = new Map<string, any>();
const CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

// –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è –∫–µ—à–∞
const cacheKey = `delivery_${businessId}_${address.lat}_${address.lon}_${address.address_id}`;
const cachedResult = deliveryCache.get(cacheKey);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
if (cachedResult && (Date.now() - cachedResult.timestamp) < CACHE_TTL) {
  console.log(`üöÄ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à –¥–ª—è –∞–¥—Ä–µ—Å–∞ ${address.address_id}`);
  deliveryInfo = cachedResult.data;
} else {
  // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
}
```

### 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–¥—Ä–µ—Å–æ–≤
```typescript
const limit = req.query.limit ? Math.min(parseInt(req.query.limit as string), 50) : 20; // –ú–∞–∫—Å–∏–º—É–º 50 –∞–¥—Ä–µ—Å–æ–≤

const addresses = await prisma.user_addreses.findMany({
  // ...
  take: limit // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
});
```

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```typescript
const startTime = Date.now();
// ... –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
const executionTime = Date.now() - startTime;
console.log(`‚ö° –ó–∞–ø—Ä–æ—Å –∞–¥—Ä–µ—Å–æ–≤ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ ${executionTime}–º—Å`);

res.json({
  success: true,
  data: {
    addresses: addressesWithDelivery,
    business_id: businessId,
    execution_time_ms: executionTime // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É
  },
  message: `–ù–∞–π–¥–µ–Ω–æ ${addresses.length} –∞–¥—Ä–µ—Å–æ–≤`
});
```

### 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
```typescript
// –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∫–µ—à–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
setInterval(() => {
  const now = Date.now();
  let cleanedCount = 0;
  for (const [key, value] of deliveryCache.entries()) {
    if ((now - value.timestamp) > CACHE_TTL) {
      deliveryCache.delete(key);
      cleanedCount++;
    }
  }
  if (cleanedCount > 0) {
    console.log(`üßπ –û—á–∏—â–µ–Ω–æ ${cleanedCount} —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ –∫–µ—à–∞ –¥–æ—Å—Ç–∞–≤–∫–∏`);
  }
}, 10 * 60 * 1000); // 10 –º–∏–Ω—É—Ç
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
1. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ–∫—Ä–∞—Ç–∏—Ç—Å—è —Å O(n) –¥–æ O(1), –≥–¥–µ n - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ç–µ—Ö –∂–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞–¥—Ä–µ—Å–æ–≤
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç:
- **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: 10 –∞–¥—Ä–µ—Å–æ–≤ √ó 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Ä–∞—Å—á–µ—Ç = 20 —Å–µ–∫—É–Ω–¥
- **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: max(2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö –∞–¥—Ä–µ—Å–æ–≤, –≤—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–µ—à—É ~1–º—Å) = ~2 —Å–µ–∫—É–Ω–¥—ã

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
- `business_id` - ID –±–∏–∑–Ω–µ—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
- `limit` - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20, –º–∞–∫—Å–∏–º—É–º 50)

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
```bash
GET /api/addresses/user/with-delivery?business_id=1&limit=10
```

### –û—Ç–≤–µ—Ç —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```json
{
  "success": true,
  "data": {
    "addresses": [...],
    "business_id": 1,
    "execution_time_ms": 450
  },
  "message": "–ù–∞–π–¥–µ–Ω–æ 5 –∞–¥—Ä–µ—Å–æ–≤"
}
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–ö–µ—à –≤ –ø–∞–º—è—Ç–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ø–æ–ª–Ω–µ–Ω –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ Redis –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

### 2. –ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `user_addreses`:
```sql
CREATE INDEX idx_user_addresses_performance ON user_addreses(user_id, isDeleted, log_timestamp);
```

### 3. –ü–∞–≥–∏–Ω–∞—Ü–∏—è
–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö:
```typescript
const offset = (page - 1) * limit;
// ... skip: offset, take: limit
```

### 4. GraphQL DataLoader
–î–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DataLoader –¥–ª—è –±–∞—Ç—á–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
–°–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É–µ—Ç:
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∏—â–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∫–µ—à–∞

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
- –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –∑–∞ –∑–∞–ø—Ä–æ—Å
- –†–∞–∑–º–µ—Ä –∫–µ—à–∞ –≤ –ø–∞–º—è—Ç–∏

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏–ª–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å API –∞–¥—Ä–µ—Å–æ–≤ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π:
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞

–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API —Å–æ–∫—Ä–∞—Ç–∏–ª–æ—Å—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–µ—Å—è—Ç–∫–æ–≤ —Å–µ–∫—É–Ω–¥ –¥–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—É–Ω–¥, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç.
