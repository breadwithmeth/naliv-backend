<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment with Saved Cards</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto; 
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section { 
            border: 1px solid #ddd; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            background: #fff;
        }
        .section h3 { 
            margin-top: 0; 
            color: #333; 
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .output { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0; 
            max-height: 300px; 
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        input, select { 
            padding: 10px; 
            margin: 8px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 14px;
        }
        .card-item {
            background: #e8f4fd;
            border: 1px solid #007bff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .card-item:hover {
            background: #d1ecf1;
            transform: translateY(-2px);
        }
        .card-item.selected {
            background: #d4edda;
            border-color: #28a745;
        }
        .order-item {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .order-item:hover {
            background: #ffeaa7;
            transform: translateY(-2px);
        }
        .order-item.selected {
            background: #d4edda;
            border-color: #28a745;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏</h1>
        <p class="info">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –æ–ø–ª–∞—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏</p>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç -->
        <div class="section">
            <h3>1. –ú–æ–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</h3>
            <button onclick="loadSavedCards()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—ã</button>
            <div class="output" id="cardsOutput">
                <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—ã" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤–∞—à–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</p>
            </div>
            <div id="cardsList"></div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="section">
            <h3>2. –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
            <div class="form-group">
                <label for="userIdInput">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="number" id="userIdInput" value="252" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <button onclick="loadUnpaidOrders()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã</button>
            </div>
            <div class="output" id="ordersOutput">
                <p>–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã"</p>
            </div>
            <div id="ordersList"></div>
        </div>

        <!-- –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ -->
        <div class="section">
            <h3>3. –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π</h3>
            <div class="form-group">
                <label for="orderIdInput">ID –∑–∞–∫–∞–∑–∞:</label>
                <input type="number" id="orderIdInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –≤—ã—à–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID">
            </div>
            <div class="form-group">
                <label for="cardIdInput">ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã:</label>
                <input type="number" id="cardIdInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –≤—ã—à–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID">
            </div>
            <button onclick="payWithSavedCard()" id="payButton" disabled>–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div class="output" id="paymentOutput"></div>
        </div>

        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="section">
            <h3>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã</h3>
            <div class="form-group">
                <label for="statusOrderId">ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
                <input type="number" id="statusOrderId" placeholder="ID –∑–∞–∫–∞–∑–∞">
                <button onclick="checkPaymentStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>
            <div class="output" id="statusOutput"></div>
        </div>

        <!-- –û–±—â–∏–π –ª–æ–≥ -->
        <div class="section">
            <h3>üìã –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div class="output" id="generalLog"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyNTIsInVzZXJuYW1lIjoic2hydiIsImVtYWlsIjoic2hydk5hbGl2QGdtYWlsLmNvbSIsImlhdCI6MTczNzk5MTA1NSwiZXhwIjoxNzM3OTk0NjU1fQ.LhCYSfhcLGIeHGU5w_fwM3j0bVrGM-IHhzK6EWuP0QY';

        let selectedCardId = null;
        let selectedOrderId = null;
        let savedCards = [];
        let unpaidOrders = [];

        function log(message, type = 'info', outputId = 'generalLog') {
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            const logEntry = `<p class="${className}">[${timestamp}] ${message}</p>`;
            output.innerHTML += logEntry;
            
            // –î—É–±–ª–∏—Ä—É–µ–º –≤ –æ–±—â–∏–π –ª–æ–≥
            if (outputId !== 'generalLog') {
                document.getElementById('generalLog').innerHTML += logEntry;
            }
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
            output.scrollTop = output.scrollHeight;
}

        function clearLog() {
            document.getElementById('generalLog').innerHTML = '';
        }

        function updatePayButton() {
            const payButton = document.getElementById('payButton');
            if (selectedCardId && selectedOrderId) {
                payButton.disabled = false;
                payButton.textContent = `–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑ #${selectedOrderId} –∫–∞—Ä—Ç–æ–π #${selectedCardId}`;
            } else {
                payButton.disabled = true;
                payButton.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –∏ –∫–∞—Ä—Ç—É';
            }
        }

        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç
        async function loadSavedCards() {
            try {
                log('üí≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç...', 'info', 'cardsOutput');

                const response = await fetch(`${API_BASE_URL}/api/user/cards`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    savedCards = result.data.cards;
                    log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${savedCards.length} –∫–∞—Ä—Ç`, 'success', 'cardsOutput');
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞—Ä—Ç—ã
                    const cardsList = document.getElementById('cardsList');
                    if (savedCards.length > 0) {
                        cardsList.innerHTML = savedCards.map(card => `
                            <div class="card-item" onclick="selectCard(${card.card_id})">
                                <strong>ID: ${card.card_id}</strong><br>
                                <span>–ù–æ–º–µ—Ä: ${card.mask}</span>
                            </div>
                        `).join('');
                    } else {
                        cardsList.innerHTML = '<p class="warning">–£ –≤–∞—Å –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ API —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç.</p>';
                    }
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç: ' + result.message, 'error', 'cardsOutput');
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞—Ä—Ç: ' + error.message, 'error', 'cardsOutput');
            }
        }

        function selectCard(cardId) {
            selectedCardId = cardId;
            document.getElementById('cardIdInput').value = cardId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            document.querySelectorAll('.card-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.card-item').classList.add('selected');
            
            log(`üí≥ –í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ä—Ç–∞ ID: ${cardId}`, 'info');
            updatePayButton();
        }

        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        async function loadUnpaidOrders() {
            try {
                const userId = document.getElementById('userIdInput').value;
                if (!userId) {
                    log('‚ùå –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', 'ordersOutput');
                    return;
                }

                log(`üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}...`, 'info', 'ordersOutput');

                const response = await fetch(`${API_BASE_URL}/api/orders/user/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã (—Å—Ç–∞—Ç—É—Å UNPAID = 66)
                    unpaidOrders = result.data.orders.filter(order => 
                        order.status?.status === 66 || order.status?.status === 0 // UNPAID –∏–ª–∏ NEW
                    );
                    
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${unpaidOrders.length} –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤`, 'success', 'ordersOutput');
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
                    const ordersList = document.getElementById('ordersList');
                    if (unpaidOrders.length > 0) {
                        ordersList.innerHTML = unpaidOrders.map(order => `
                            <div class="order-item" onclick="selectOrder(${order.order_id})">
                                <strong>–ó–∞–∫–∞–∑ #${order.order_id}</strong><br>
                                <span>UUID: ${order.order_uuid}</span><br>
                                <span>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${order.cost?.cost || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} ‚Ç∏</span><br>
                                <span>–°—Ç–∞—Ç—É—Å: ${order.status?.status === 66 ? '–ù–µ –æ–ø–ª–∞—á–µ–Ω' : '–ù–æ–≤—ã–π'}</span><br>
                                <span>–î–∞—Ç–∞: ${new Date(order.log_timestamp).toLocaleString('ru-RU')}</span>
                            </div>
                        `).join('');
                    } else {
                        ordersList.innerHTML = '<p class="warning">–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
                    }
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ' + result.message, 'error', 'ordersOutput');
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–∫–∞–∑–æ–≤: ' + error.message, 'error', 'ordersOutput');
            }
        }

        function selectOrder(orderId) {
            selectedOrderId = orderId;
            document.getElementById('orderIdInput').value = orderId;
            document.getElementById('statusOrderId').value = orderId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            document.querySelectorAll('.order-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.order-item').classList.add('selected');
            
            log(`üì¶ –í—ã–±—Ä–∞–Ω –∑–∞–∫–∞–∑ ID: ${orderId}`, 'info');
            updatePayButton();
        }

        // 3. –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ–π
        async function payWithSavedCard() {
            try {
                const orderId = parseInt(document.getElementById('orderIdInput').value);
                const cardId = parseInt(document.getElementById('cardIdInput').value);

                if (!orderId || !cardId) {
                    log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –∏ –∫–∞—Ä—Ç—É –¥–ª—è –æ–ø–ª–∞—Ç—ã', 'error', 'paymentOutput');
                    return;
                }

                log(`üí≥ –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ ${orderId} –∫–∞—Ä—Ç–æ–π ${cardId}...`, 'info', 'paymentOutput');

                const response = await fetch(`${API_BASE_URL}/api/payments/pay-with-saved-card`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        saved_card_id: cardId
                    })
                });

                if (response.headers.get('content-type')?.includes('text/html')) {
                    log('‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã!', 'success', 'paymentOutput');
                    const html = await response.text();
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ HTML
                    const orderMatch = html.match(/–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:<\/strong>\s*([^<]+)/);
                    const amountMatch = html.match(/–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:<\/strong>\s*(\d+(?:\.\d+)?)/);
                    const cardMatch = html.match(/\*\*\*\* \*\*\*\* \*\*\*\* (\d{4})/);
                    
                    if (orderMatch) {
                        log(`üì¶ –ó–∞–∫–∞–∑: ${orderMatch[1].trim()}`, 'success', 'paymentOutput');
                    }
                    if (amountMatch) {
                        log(`üí∞ –°—É–º–º–∞: ${amountMatch[1]} ‚Ç∏`, 'info', 'paymentOutput');
                    }
                    if (cardMatch) {
                        log(`üí≥ –ö–∞—Ä—Ç–∞: **** **** **** ${cardMatch[1]}`, 'info', 'paymentOutput');
                    }
                    
                    // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Ñ–æ—Ä–º—É
                    const openPayment = confirm('–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ?');
                    if (openPayment) {
                        const paymentWindow = window.open('', '_blank');
                        paymentWindow.document.write(html);
                        log('üöÄ –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ', 'success', 'paymentOutput');
                    }
                    
                } else {
                    const result = await response.json();
                    if (result.success) {
                        log('‚úÖ ' + JSON.stringify(result, null, 2), 'success', 'paymentOutput');
                    } else {
                        log('‚ùå ' + result.message, 'error', 'paymentOutput');
                    }
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ' + error.message, 'error', 'paymentOutput');
            }
        }

        // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
        async function checkPaymentStatus() {
            try {
                const orderId = document.getElementById('statusOrderId').value;
                
                if (!orderId) {
                    log('‚ùå –í–≤–µ–¥–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏', 'error', 'statusOutput');
                    return;
                }

                log(`üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ ${orderId}`, 'info', 'statusOutput');

                const response = await fetch(`${API_BASE_URL}/api/payments/order-payment-status/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const order = result.data.order;
                    const cost = result.data.cost;
                    const payment = result.data.payment;
                    
                    log(`‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: ${order.status === 2 ? '–û–ø–ª–∞—á–µ–Ω' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω'}`, 'success', 'statusOutput');
                    log(`üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost?.total || '–ù/–î'} ‚Ç∏`, 'info', 'statusOutput');
                    
                    if (payment) {
                        log(`üí≥ –ü–ª–∞—Ç–µ–∂: ${payment.payment_method} (Invoice: ${payment.payment_invoice_id})`, 'info', 'statusOutput');
                    }
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + result.message, 'error', 'statusOutput');
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'error', 'statusOutput');
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–∫–æ–Ω
        window.addEventListener('message', function(event) {
            if (event.data.type === 'payment_success') {
                log(`üéâ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω! Invoice: ${event.data.invoiceId}`, 'success');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
                loadUnpaidOrders();
            } else if (event.data.type === 'payment_failure') {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞: ${event.data.error}`, 'error');
            }
        });

        log('üí≥ –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ –≥–æ—Ç–æ–≤–∞', 'success');
    </script>
</body>
</html>
