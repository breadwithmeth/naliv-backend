<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Timeout - –í–∞–ª—é—Ç–∞ USD</title>
    <script src="https://epay.homebank.kz/payform/payment-api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        .data-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .config-box {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Timeout - –í–∞–ª—é—Ç–∞ USD</h1>
        
        <div class="alert alert-warning">
            <strong>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:</strong><br>
            –í —Ä–∞–±–æ—á–µ–º PHP –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞–ª—é—Ç–∞ <strong>USD</strong>, –∞ –Ω–µ KZT!<br>
            –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π timeout –æ—à–∏–±–∫–∏.
        </div>

        <div class="config-box">
            <strong>üîç –ê–Ω–∞–ª–∏–∑ PHP –∫–æ–¥–∞:</strong><br>
            ‚Ä¢ <code>currency: "USD"</code> –≤ —Ä–∞–±–æ—á–µ–º –∫–æ–¥–µ<br>
            ‚Ä¢ <code>terminal: "bb4dec49-6e30-41d0-b16b-8ba1831a854b"</code><br>
            ‚Ä¢ <code>halyk.cardverification()</code> –º–µ—Ç–æ–¥<br>
            ‚Ä¢ <code>postLink: "https://chorenn.naliv.kz/api/payment.php"</code>
        </div>

        <div class="data-box" id="currentData">
            <strong>üìä –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:</strong><br>
            <div id="dataDetails">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="startWithUSD()" id="usdBtn">üí∞ –ó–∞–ø—É—Å–∫ —Å USD (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)</button>
            <button onclick="startWithKZT()" id="kztBtn">‚ö†Ô∏è –ó–∞–ø—É—Å–∫ —Å KZT (–æ—à–∏–±–∫–∞)</button>
            <button onclick="autoFix()" id="autoBtn">üîÑ –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
        </div>

        <div id="statusAlert" class="alert alert-info">
            –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–∞–ª—é—Ç–æ–π USD
        </div>

        <div class="data-box" id="paymentHistory">
            <strong>üìã –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤:</strong><br>
            <div id="historyDetails">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞...</div>
        </div>
    </div>

    <script>
        let paymentHistory = [];
        let autoFixRunning = false;

        function updateStatus(message, type = 'info') {
            const statusAlert = document.getElementById('statusAlert');
            statusAlert.className = `alert alert-${type}`;
            statusAlert.innerHTML = message;
        }

        function updateCurrentData(invoiceId, auth, currency) {
            document.getElementById('dataDetails').innerHTML = `
                <strong>Invoice ID:</strong> ${invoiceId}<br>
                <strong>Auth:</strong> ${auth.substring(0, 20)}...<br>
                <strong>–í–∞–ª—é—Ç–∞:</strong> <span style="color: ${currency === 'USD' ? 'green' : 'red'}">${currency}</span><br>
                <strong>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${new Date().toLocaleTimeString()}<br>
                <strong>–°—Ç–∞—Ç—É—Å:</strong> ${currency === 'USD' ? '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚ö†Ô∏è –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å timeout'}
            `;
        }

        function addToHistory(invoiceId, currency, result, error = null) {
            const timestamp = new Date().toLocaleTimeString();
            paymentHistory.push({
                timestamp,
                invoiceId: invoiceId.substring(0, 15) + '...',
                currency,
                result,
                error
            });

            const historyHtml = paymentHistory.map(item => 
                `[${item.timestamp}] ${item.currency} ‚Üí ${item.result}${item.error ? ` (${item.error})` : ''}`
            ).reverse().join('<br>');

            document.getElementById('historyDetails').innerHTML = historyHtml;
        }

        function generateUniqueInvoiceId() {
            const timestamp = Date.now();
            const userId = 252;
            const random = Math.floor(Math.random() * 100);
            const refresh = Math.floor(Math.random() * 10);
            
            return `CARD${timestamp}${userId.toString().padStart(3, '0')}${random}${refresh}`;
        }

        async function getFreshAuth(invoiceId) {
            try {
                const response = await fetch('http://localhost:3000/api/payments/save-card/test-init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 252,
                        amount: 0,
                        invoiceId: invoiceId
                    })
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å auth —Ç–æ–∫–µ–Ω');
                }

                return data.data.auth;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è auth:', error);
                throw error;
            }
        }

        async function createPaymentObject(currency) {
            const invoiceId = generateUniqueInvoiceId();
            const auth = await getFreshAuth(invoiceId);
            
            updateCurrentData(invoiceId, auth, currency);

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ PHP –∫–æ–¥–∞
            const paymentObject = {
                invoiceId: invoiceId,
                backLink: "https://chorenn.naliv.kz/success",
                failureBackLink: "https://chorenn.naliv.kz/failure",
                postLink: "https://chorenn.naliv.kz/api/payment.php",
                language: "rus",
                description: `–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (${currency})`,
                accountId: "252",
                terminal: "bb4dec49-6e30-41d0-b16b-8ba1831a854b",
                amount: 0,
                currency: currency,
                cardSave: true,
                paymentType: "cardVerification"
            };
            paymentObject.auth = auth;
            
            return { paymentObject, invoiceId, auth };
        }

        async function startWithUSD() {
            try {
                document.getElementById('usdBtn').disabled = true;
                updateStatus('üí∞ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –≤–∞–ª—é—Ç–æ–π USD (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)...', 'info');

                const { paymentObject, invoiceId, auth } = await createPaymentObject('USD');
                
                setupCallbacks(invoiceId, auth, 'USD');
                console.log('–ó–∞–ø—É—Å–∫ —Å USD:', paymentObject);
                
                halyk.cardverification(paymentObject);

            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞ USD: ${error.message}`, 'danger');
                addToHistory('N/A', 'USD', '–û–®–ò–ë–ö–ê', error.message);
            } finally {
                document.getElementById('usdBtn').disabled = false;
            }
        }

        async function startWithKZT() {
            try {
                document.getElementById('kztBtn').disabled = true;
                updateStatus('‚ö†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –≤–∞–ª—é—Ç–æ–π KZT (–º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å timeout)...', 'warning');

                const { paymentObject, invoiceId, auth } = await createPaymentObject('KZT');
                
                setupCallbacks(invoiceId, auth, 'KZT');
                console.log('–ó–∞–ø—É—Å–∫ —Å KZT:', paymentObject);
                
                halyk.cardverification(paymentObject);

            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞ KZT: ${error.message}`, 'danger');
                addToHistory('N/A', 'KZT', '–û–®–ò–ë–ö–ê', error.message);
            } finally {
                document.getElementById('kztBtn').disabled = false;
            }
        }

        async function autoFix() {
            if (autoFixRunning) return;
            
            autoFixRunning = true;
            document.getElementById('autoBtn').disabled = true;
            
            updateStatus('üîÑ –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–æ–±—É–µ–º USD –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥...', 'info');
            
            let attempts = 0;
            const maxAttempts = 5;
            
            const interval = setInterval(async () => {
                attempts++;
                updateStatus(`üîÑ –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts} —Å USD...`, 'info');
                
                try {
                    await startWithUSD();
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        autoFixRunning = false;
                        document.getElementById('autoBtn').disabled = false;
                        updateStatus('‚úÖ –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'success');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', error);
                }
            }, 5000);
        }

        function setupCallbacks(invoiceId, auth, currency) {
            window.halyk_success = function(data) {
                console.log('‚úÖ –£—Å–ø–µ—Ö:', data);
                updateStatus(`üéâ –ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω —Å –≤–∞–ª—é—Ç–æ–π ${currency}!`, 'success');
                addToHistory(invoiceId, currency, '–£–°–ü–ï–•');
                
                if (currency === 'USD') {
                    updateStatus('üéØ –†–ï–®–ï–ù–ò–ï –ù–ê–ô–î–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞–ª—é—Ç—É USD!', 'success');
                }
            };

            window.halyk_failure = function(error) {
                console.log('‚ùå –û—à–∏–±–∫–∞:', error);
                
                const errorMsg = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                
                if (errorMsg.includes('–∏—Å—Ç–µ–∫–ª–æ') || errorMsg.includes('timeout')) {
                    updateStatus(`‚è∞ Timeout —Å –≤–∞–ª—é—Ç–æ–π ${currency}!`, 'danger');
                    addToHistory(invoiceId, currency, 'TIMEOUT', errorMsg);
                    
                    if (currency === 'KZT') {
                        updateStatus('üéØ –ö–∞–∫ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å: KZT –≤—ã–∑—ã–≤–∞–µ—Ç timeout. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ USD!', 'warning');
                        setTimeout(() => {
                            updateStatus('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å–∫ —Å USD"', 'info');
                        }, 3000);
                    } else {
                        updateStatus('‚ùå –î–∞–∂–µ USD –¥–∞–µ—Ç timeout. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.', 'danger');
                    }
                } else {
                    updateStatus(`‚ùå –û—à–∏–±–∫–∞ ${currency}: ${errorMsg}`, 'danger');
                    addToHistory(invoiceId, currency, '–û–®–ò–ë–ö–ê', errorMsg);
                }
            };

            window.halyk_cancelled = function() {
                console.log('‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                updateStatus('‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'info');
                addToHistory(invoiceId, currency, '–û–¢–ú–ï–ù–ï–ù–û');
            };
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üìã –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –≤–∞–ª—é—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ USD!', 'info');
        });
    </script>
</body>
</html>
