<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Halyk Cards API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #444;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        .auth-section {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input:focus {
            border-color: #007bff;
            outline: none;
        }

        .button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .button.secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .button.success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }

        .button.warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
        }

        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .result.info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .card-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .card-item:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .card-mask {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .card-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .card-source {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }

        .source-halyk {
            background: #28a745;
            color: white;
        }

        .source-local {
            background: #6c757d;
            color: white;
        }

        .source-combined {
            background: #007bff;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #007bff;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Halyk Cards API</h1>
        
        <div class="info-box">
            <strong>üìã –û–ø–∏—Å–∞–Ω–∏–µ:</strong> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö API –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç –∏–∑ Halyk Bank API —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ https://epayment.kz/docs/poluchenie-spiska-kart
        </div>

        <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div class="auth-section">
            <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <div class="form-group">
                <label for="jwtToken">JWT –¢–æ–∫–µ–Ω:</label>
                <input type="text" id="jwtToken" placeholder="–í–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ —á–µ—Ä–µ–∑ quick-auth.html">
            </div>
            <div class="form-group">
                <label for="accountId">Account ID (user_id):</label>
                <input type="text" id="accountId" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ —Ç–æ–∫–µ–Ω–∞)" value="">
            </div>
            <button class="button" onclick="loadTokenFromStorage()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</button>
            <button class="button secondary" onclick="testTokenValidation()">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        </div>
    </div>

    <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ -->
    <div class="container">
        <h2>üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –º–µ—Ç–æ–¥–æ–≤</h2>
        
        <div style="margin-bottom: 20px;">
            <button class="button" onclick="testLocalCards()">üóÑÔ∏è –õ–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã (–ë–î)</button>
            <button class="button" onclick="testHalykApiCards()">üè¶ Halyk Bank API</button>
            <button class="button success" onclick="testCombinedCards()">üîó –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</button>
            <button class="button warning" onclick="testNewPaymentEndpoints()">üí≥ –ù–æ–≤—ã–µ Payment —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã</button>
        </div>

        <div id="apiResults" class="result" style="display: none;"></div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="container">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        
        <div class="stats" id="statsContainer" style="display: none;">
            <div class="stat-item">
                <div class="stat-number" id="statTotal">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∫–∞—Ä—Ç</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statHalyk">0</div>
                <div class="stat-label">Halyk API</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statLocal">0</div>
                <div class="stat-label">–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statCombined">0</div>
                <div class="stat-label">–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ</div>
            </div>
        </div>

        <div id="cardsContainer"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        let currentToken = '';
        let currentAccountId = '';

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ localStorage
        function loadTokenFromStorage() {
            const token = localStorage.getItem('quickAuthToken') || 
                         localStorage.getItem('addCardTestToken') || 
                         localStorage.getItem('bonusApiAuthToken');
            
            if (token) {
                document.getElementById('jwtToken').value = token;
                currentToken = token;
                showResult('‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞', 'success');
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å user_id –∏–∑ —Ç–æ–∫–µ–Ω–∞
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    if (payload.user_id) {
                        document.getElementById('accountId').value = payload.user_id;
                        currentAccountId = payload.user_id;
                        showResult(`‚úÖ Account ID —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${payload.user_id}`, 'success');
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å user_id –∏–∑ —Ç–æ–∫–µ–Ω–∞:', e);
                }
            } else {
                showResult('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ quick-auth.html', 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
        async function testTokenValidation() {
            const token = document.getElementById('jwtToken').value.trim();
            if (!token) {
                showResult('‚ùå –í–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω', 'error');
                return;
            }

            try {
                showResult('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/api/user/cards?source=local`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    currentToken = token;
                    currentAccountId = document.getElementById('accountId').value || 'auto';
                    showResult(`‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç ${result.data.total} –∫–∞—Ä—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î`, 'success');
                } else {
                    showResult(`‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: ${result.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π API)
        async function testLocalCards() {
            if (!validateAuth()) return;

            try {
                showResult('üóÑÔ∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/api/user/cards?source=local`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const result = await response.json();
                displayCardsResult('–õ–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã (–ë–î)', result);
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Halyk Bank API
        async function testHalykApiCards() {
            if (!validateAuth()) return;

            try {
                showResult('üè¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç –∏–∑ Halyk Bank API...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/api/user/cards?source=halyk`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const result = await response.json();
                displayCardsResult('Halyk Bank API', result);
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ä—Ç –∏–∑ Halyk API: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç
        async function testCombinedCards() {
            if (!validateAuth()) return;

            try {
                showResult('üîó –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç (–ë–î + Halyk API)...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/api/user/cards?source=combined`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const result = await response.json();
                displayCardsResult('–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã', result);
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö Payment —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
        async function testNewPaymentEndpoints() {
            if (!validateAuth()) return;

            try {
                showResult('üí≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö Payment —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤...', 'info');
                
                // –¢–µ—Å—Ç 1: /api/payments/saved-cards/:accountId
                const accountId = currentAccountId || 'auto';
                showResult(`üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /api/payments/saved-cards/${accountId}...`, 'info');
                
                const response1 = await fetch(`${API_BASE_URL}/api/payments/saved-cards/${accountId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const result1 = await response1.json();
                showResult(`üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç /api/payments/saved-cards/${accountId}:\n${JSON.stringify(result1, null, 2)}`, result1.success ? 'success' : 'error');

                // –¢–µ—Å—Ç 2: /api/payments/saved-cards-combined
                showResult('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /api/payments/saved-cards-combined...', 'info');
                
                const response2 = await fetch(`${API_BASE_URL}/api/payments/saved-cards-combined`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const result2 = await response2.json();
                showResult(`üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç /api/payments/saved-cards-combined:\n${JSON.stringify(result2, null, 2)}`, result2.success ? 'success' : 'error');

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (result2.success) {
                    displayCardsResult('Payment API - –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã', result2);
                }
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Payment —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤: ${error.message}`, 'error');
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function validateAuth() {
            const token = document.getElementById('jwtToken').value.trim();
            if (!token) {
                showResult('‚ùå –í–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω', 'error');
                return false;
            }
            currentToken = token;
            currentAccountId = document.getElementById('accountId').value.trim();
            return true;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.style.display = 'block';
            resultsDiv.className = `result ${type}`;
            resultsDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç
        function displayCardsResult(title, result) {
            const container = document.getElementById('cardsContainer');
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result error">
                        <strong>${title} - –û—à–∏–±–∫–∞:</strong><br>
                        ${result.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                    </div>
                `;
                return;
            }

            const cards = result.data.cards || [];
            const total = result.data.total || 0;
            const sources = result.data.sources || {};

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStats(sources, total);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞—Ä—Ç—ã
            let cardsHtml = `
                <div class="result success">
                    <strong>${title}:</strong><br>
                    –ù–∞–π–¥–µ–Ω–æ: ${total} –∫–∞—Ä—Ç<br>
                    –ò—Å—Ç–æ—á–Ω–∏–∫: ${result.data.source || 'unknown'}<br>
                    –í—Ä–µ–º—è: ${new Date().toLocaleTimeString()}
                </div>
            `;

            if (cards.length > 0) {
                cardsHtml += '<div class="cards-grid">';
                
                cards.forEach(card => {
                    const source = card.source || 'unknown';
                    const sourceClass = source.includes('halyk') ? 'source-halyk' : 
                                       source.includes('local') ? 'source-local' : 'source-combined';
                    
                    cardsHtml += `
                        <div class="card-item">
                            <div class="card-mask">${card.mask || card.card_mask || 'N/A'}</div>
                            <div class="card-details">
                                ${card.card_id ? `Local ID: ${card.card_id}<br>` : ''}
                                ${card.halyk_id || card.halyk_card_id ? `Halyk ID: ${(card.halyk_id || card.halyk_card_id).substring(0, 20)}...<br>` : ''}
                                ${card.payer_name ? `–í–ª–∞–¥–µ–ª–µ—Ü: ${card.payer_name}<br>` : ''}
                                ${card.created_date ? `–°–æ–∑–¥–∞–Ω–∞: ${new Date(card.created_date).toLocaleDateString()}<br>` : ''}
                                ${card.payment_available !== undefined ? `–î–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: ${card.payment_available ? '–î–∞' : '–ù–µ—Ç'}<br>` : ''}
                                ${card.local_record !== undefined ? `–ï—Å—Ç—å –≤ –ë–î: ${card.local_record ? '–î–∞' : '–ù–µ—Ç'}` : ''}
                            </div>
                            <span class="card-source ${sourceClass}">${source}</span>
                        </div>
                    `;
                });
                
                cardsHtml += '</div>';
            } else {
                cardsHtml += '<div class="result info">–ö–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }

            container.innerHTML = cardsHtml;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(sources, total) {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.style.display = 'grid';

            document.getElementById('statTotal').textContent = total || 0;
            document.getElementById('statHalyk').textContent = sources.halyk_api || 0;
            document.getElementById('statLocal').textContent = sources.local_db || 0;
            document.getElementById('statCombined').textContent = sources.combined || total || 0;
        }

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            loadTokenFromStorage();
        };
    </script>
</body>
</html>
