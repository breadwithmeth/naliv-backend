# üîß FCM Troubleshooting Guide

## –û—à–∏–±–∫–∞: `messaging/third-party-auth-error`

### üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–û—à–∏–±–∫–∞ `Auth error from APNS or Web Push Service` –æ–±—ã—á–Ω–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞:

1. **–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π FCM —Ç–æ–∫–µ–Ω** - —Ç–æ–∫–µ–Ω —É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞** - –ø—Ä–æ–±–ª–µ–º—ã —Å APNS/Web Push –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
3. **–¢–æ–∫–µ–Ω –æ—Ç –¥—Ä—É–≥–æ–≥–æ Firebase –ø—Ä–æ–µ–∫—Ç–∞** - –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤
4. **–û—Ç–æ–∑–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã** - –ø—Ä–æ–±–ª–µ–º—ã —Å Apple Push Notification service

## üöÄ –†–µ—à–µ–Ω–∏—è

### 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ FCM —Ç–æ–∫–µ–Ω–∞

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π endpoint –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:

```bash
# –¢–µ—Å—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
curl -X POST http://localhost:3000/api/notifications/test-token \
  -H "Authorization: Bearer USER_TOKEN" \
  -H "Content-Type: application/json"

# –¢–µ—Å—Ç —Ç–æ–∫–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)
curl -X POST http://localhost:3000/api/notifications/test-token \
  -H "Authorization: Bearer EMPLOYEE_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userId": 123}'
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "success": true,
  "data": {
    "diagnostics": {
      "user_id": 123,
      "user_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤", 
      "has_token": true,
      "token_preview": "fGHJ1234567890abcdef...",
      "format_valid": true,
      "status": "send_failed",
      "message": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ APNS/Web Push",
      "test_result": {
        "success": false,
        "error": "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ APNS/Web Push",
        "error_code": "messaging/third-party-auth-error"
      },
      "firebase_info": {
        "project_id": "naliv-web",
        "initialized": true
      }
    }
  }
}
```

### 2. –û—á–∏—Å—Ç–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –æ—á–∏—Å—Ç–∏—Ç–µ –µ–≥–æ:

```bash
curl -X DELETE http://localhost:3000/api/notifications/cleanup-token \
  -H "Authorization: Bearer EMPLOYEE_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userId": 123}'
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Firebase –ø—Ä–æ–µ–∫—Ç–∞

#### A. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ APNS (–¥–ª—è iOS)
1. –ó–∞–π–¥–∏—Ç–µ –≤ Firebase Console
2. Project Settings ‚Üí Cloud Messaging
3. –í —Ä–∞–∑–¥–µ–ª–µ "Apple app configuration" –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ APNs Authentication Key –∑–∞–≥—Ä—É–∂–µ–Ω
   - ‚úÖ Key ID —É–∫–∞–∑–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - ‚úÖ Team ID —É–∫–∞–∑–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### B. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Web Push (–¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
1. –í Firebase Console ‚Üí Project Settings ‚Üí Cloud Messaging
2. –í —Ä–∞–∑–¥–µ–ª–µ "Web configuration" –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ Web Push certificates –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
   - ‚úÖ Sender ID –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

#### C. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
- `FIREBASE_PROJECT_ID` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–µ–∫—Ç—É –≤ Firebase Console
- FCM —Ç–æ–∫–µ–Ω—ã –±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –∂–µ –ø—Ä–æ–µ–∫—Ç–∞

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ FCM —Ç–æ–∫–µ–Ω–∞

–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–∏—Ç—å FCM —Ç–æ–∫–µ–Ω:

```javascript
// –í –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (React Native / Flutter / Web)
// –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
const newToken = await messaging().getToken();

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
await fetch('/api/users/fcm-token', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${userToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    fcmToken: newToken
  })
});
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Account –ø—Ä–∞–≤

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Service Account –∏–º–µ–µ—Ç –Ω—É–∂–Ω—ã–µ –ø—Ä–∞–≤–∞:

1. –ó–∞–π–¥–∏—Ç–µ –≤ Google Cloud Console
2. IAM & Admin ‚Üí Service Accounts
3. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à Service Account
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–æ–ª–∏:
   - ‚úÖ `Firebase Admin SDK Administrator Service Agent`
   - ‚úÖ `Firebase Cloud Messaging Admin`

## üõ†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. **–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞** –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
2. **–û—á–∏—â–∞–µ—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã** –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
3. **–õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** –æ–± –æ—à–∏–±–∫–∞—Ö
4. **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

### –ü—Ä–∏–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏

```typescript
// –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è
if (!pushResult.success && 
    (pushResult.error_code === 'messaging/registration-token-not-registered' ||
     pushResult.error_code === 'messaging/invalid-registration-token' ||
     pushResult.error_code === 'messaging/sender-id-mismatch')) {
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
  await prisma.user.update({
    where: { user_id: userId },
    data: { OneSignalId: null }
  });
}
```

## üìä –ö–æ–¥—ã –æ—à–∏–±–æ–∫ FCM

| –ö–æ–¥ –æ—à–∏–±–∫–∏ | –û–ø–∏—Å–∞–Ω–∏–µ | –†–µ—à–µ–Ω–∏–µ |
|------------|----------|---------|
| `messaging/registration-token-not-registered` | –¢–æ–∫–µ–Ω –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω | –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ |
| `messaging/invalid-registration-token` | –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ | –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω |
| `messaging/third-party-auth-error` | –û—à–∏–±–∫–∞ APNS/Web Push | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase |
| `messaging/sender-id-mismatch` | –¢–æ–∫–µ–Ω –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç |
| `messaging/quota-exceeded` | –ü—Ä–µ–≤—ã—à–µ–Ω–∞ –∫–≤–æ—Ç–∞ | –ü–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å |
| `messaging/unavailable` | –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ |

## üîÑ Workflow –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

1. **–ü–æ–ª—É—á–∏—Ç–µ –æ—à–∏–±–∫—É** –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É** —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ `/api/notifications/test-token`
3. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
   - –ï—Å–ª–∏ `format_valid: false` ‚Üí —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
   - –ï—Å–ª–∏ `status: send_failed` ‚Üí –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π
   - –ï—Å–ª–∏ `should_cleanup: true` ‚Üí —Ç–æ–∫–µ–Ω –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
4. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è**:
   - –û—á–∏—Å—Ç–∏—Ç–µ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ `/api/notifications/cleanup-token`
   - –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase

## üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ–∫–µ–Ω—ã** –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–π—Ç–µ** –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
3. **–õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –æ—à–∏–±–∫–∏** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
4. **–ò–º–µ–π—Ç–µ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã** (SMS, email)
5. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞:

1. **–í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ** push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
2. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã** (SMS/email)
3. **–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Firebase** –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∏—Ö —Å–µ—Ä–≤–∏—Å–µ
4. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π Firebase –ø—Ä–æ–µ–∫—Ç** –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
