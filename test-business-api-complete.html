<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç Business Order API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .warning { background: #ffc107; color: black; }
        .danger { background: #dc3545; }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç Business Order API</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–∏–∑–Ω–µ—Å API –∑–∞–∫–∞–∑–æ–≤</p>
        
        <div class="test-section">
            <strong>üîë –¢–æ–∫–µ–Ω –±–∏–∑–Ω–µ—Å–∞:</strong>
            <input type="text" id="token" placeholder="Business JWT —Ç–æ–∫–µ–Ω" style="width: 300px;">
        </div>
    </div>

    <div class="container">
        <div class="test-section">
            <h3>1Ô∏è‚É£ –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h3>
            <button onclick="getOrders()">–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</button>
        </div>

        <div class="test-section">
            <h3>2Ô∏è‚É£ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
            <input type="number" id="orderId" placeholder="ID –∑–∞–∫–∞–∑–∞" value="1">
            <button onclick="getOrderById()">–ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ ID</button>
        </div>

        <div class="test-section">
            <h3>3Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞</h3>
            <input type="number" id="statusOrderId" placeholder="ID –∑–∞–∫–∞–∑–∞" value="1">
            <select id="newStatus">
                <option value="0">–ù–æ–≤—ã–π</option>
                <option value="1">–ü—Ä–∏–Ω—è—Ç</option>
                <option value="2">–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ (–ø–µ—Ä–µ—Å—á–µ—Ç!)</option>
                <option value="3">–î–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è</option>
                <option value="4">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                <option value="6">–û—Ç–º–µ–Ω–µ–Ω</option>
            </select>
            <button onclick="updateStatus()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        </div>

        <div class="test-section">
            <h3>4Ô∏è‚É£ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞</h3>
            <input type="number" id="quantityOrderId" placeholder="ID –∑–∞–∫–∞–∑–∞" value="1">
            <input type="number" id="itemRelationId" placeholder="Item Relation ID" value="1">
            <input type="number" id="newQuantity" placeholder="–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="2" min="1">
            <button onclick="updateQuantity()">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</button>
        </div>

        <div class="test-section">
            <h3>5Ô∏è‚É£ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç</h3>
            <button class="success" onclick="runFullTest()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
            <button class="warning" onclick="testCostRecalculation()">‚ö° –¢–µ—Å—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</button>
        </div>
    </div>

    <div class="container">
        <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
        <div id="response" class="response">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/business';
        
        function log(message) {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n\n`;
            responseDiv.scrollTop = responseDiv.scrollHeight;
        }

        function clear() {
            document.getElementById('response').textContent = '';
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const token = document.getElementById('token').value;
            if (!token) {
                throw new Error('–¢–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω');
            }

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_BASE}${endpoint}`, options);
            return await response.json();
        }

        async function getOrders() {
            try {
                log('üîç –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤...');
                const data = await apiCall('/orders');
                log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${data.data?.orders?.length || 0}`);
                log(JSON.stringify(data, null, 2));
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function getOrderById() {
            try {
                const orderId = document.getElementById('orderId').value;
                if (!orderId) throw new Error('ID –∑–∞–∫–∞–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
                
                log(`üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ${orderId}...`);
                const data = await apiCall(`/orders/${orderId}`);
                log(`‚úÖ –ó–∞–∫–∞–∑ –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å: ${data.data?.order?.current_status?.status_name}`);
                log(`üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${data.data?.order?.cost_summary?.total_cost}`);
                log(JSON.stringify(data, null, 2));
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function updateStatus() {
            try {
                const orderId = document.getElementById('statusOrderId').value;
                const status = parseInt(document.getElementById('newStatus').value);
                if (!orderId) throw new Error('ID –∑–∞–∫–∞–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
                
                log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ ${orderId} –Ω–∞ ${status}...`);
                if (status === 2) log('‚ö° –í–Ω–∏–º–∞–Ω–∏–µ: –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å!');
                
                const data = await apiCall(`/orders/${orderId}/status`, 'PATCH', { status });
                log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ${data.message}`);
                log(JSON.stringify(data, null, 2));
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function updateQuantity() {
            try {
                const orderId = document.getElementById('quantityOrderId').value;
                const itemRelationId = document.getElementById('itemRelationId').value;
                const quantity = parseInt(document.getElementById('newQuantity').value);
                
                if (!orderId || !itemRelationId || !quantity) {
                    throw new Error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                }
                
                log(`üì¶ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑–µ ${orderId}...`);
                const data = await apiCall(`/orders/${orderId}/items/${itemRelationId}`, 'PATCH', { quantity });
                log(`‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.message}`);
                log(JSON.stringify(data, null, 2));
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function testCostRecalculation() {
            clear();
            log('‚ö° –¢–ï–°–¢ –ü–ï–†–ï–°–ß–ï–¢–ê –°–¢–û–ò–ú–û–°–¢–ò');
            log('========================');
            
            try {
                const orderId = document.getElementById('orderId').value || 1;
                
                // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                log('1Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–∫–∞–∑–∞...');
                let orderData = await apiCall(`/orders/${orderId}`);
                log(`–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${orderData.data?.order?.current_status?.status_name}`);
                log(`–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${orderData.data?.order?.cost_summary?.total_cost}`);
                
                // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å 1 (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
                log('\n2Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "–ü—Ä–∏–Ω—è—Ç"...');
                await apiCall(`/orders/${orderId}/status`, 'PATCH', { status: 1 });
                
                // 3. –ü–æ–ª—É—á–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞ 1
                orderData = await apiCall(`/orders/${orderId}`);
                const costBefore = orderData.data?.order?.cost_summary?.total_cost;
                log(`–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞: ${costBefore}`);
                
                // 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å 2 (–ø–µ—Ä–µ—Å—á–µ—Ç!)
                log('\n3Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" (–ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏)...');
                await apiCall(`/orders/${orderId}/status`, 'PATCH', { status: 2 });
                
                // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
                log('\n4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏...');
                orderData = await apiCall(`/orders/${orderId}`);
                const costAfter = orderData.data?.order?.cost_summary?.total_cost;
                log(`–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞: ${costAfter}`);
                
                // 6. –†–µ–∑—É–ª—å—Ç–∞—Ç
                log('\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–ï–°–¢–ê:');
                log(`–î–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞: ${costBefore}`);
                log(`–ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞: ${costAfter}`);
                log(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${costAfter !== costBefore ? '–ï–°–¢–¨' : '–ù–ï–¢'}`);
                
                if (costAfter !== costBefore) {
                    log('‚úÖ –ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                } else {
                    log('‚ÑπÔ∏è –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –±—ã–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π)');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ: ${error.message}`);
            }
        }

        async function runFullTest() {
            clear();
            log('üöÄ –ó–ê–ü–£–°–ö –ü–û–õ–ù–û–ì–û –¢–ï–°–¢–ê');
            log('======================');
            
            try {
                // 1. –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                log('1Ô∏è‚É£ –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤...');
                const ordersData = await apiCall('/orders');
                log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${ordersData.data?.orders?.length || 0}`);
                
                if (!ordersData.data?.orders?.length) {
                    log('‚ùå –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                    return;
                }
                
                const testOrderId = ordersData.data.orders[0].order_id;
                log(`üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–∞–∑ ID: ${testOrderId}`);
                
                // 2. –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
                log('\n2Ô∏è‚É£ –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞...');
                const orderData = await apiCall(`/orders/${testOrderId}`);
                log(`‚úÖ –ó–∞–∫–∞–∑ –ø–æ–ª—É—á–µ–Ω: ${orderData.data?.order?.current_status?.status_name}`);
                log(`üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${orderData.data?.order?.cost_summary?.total_cost}`);
                log(`üì¶ –¢–æ–≤–∞—Ä–æ–≤: ${orderData.data?.order?.items_count}`);
                
                // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                log('\n3Ô∏è‚É£ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞...');
                await apiCall(`/orders/${testOrderId}/status`, 'PATCH', { status: 1 });
                log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ "–ü—Ä–∏–Ω—è—Ç"');
                
                // 4. –¢–µ—Å—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (—Å—Ç–∞—Ç—É—Å 2)
                log('\n4Ô∏è‚É£ –¢–µ—Å—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏...');
                await apiCall(`/orders/${testOrderId}/status`, 'PATCH', { status: 2 });
                log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" —Å –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º');
                
                // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                const finalOrder = await apiCall(`/orders/${testOrderId}`);
                if (finalOrder.data?.order?.items?.length > 0) {
                    const firstItem = finalOrder.data.order.items[0];
                    log('\n5Ô∏è‚É£ –¢–µ—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞...');
                    await apiCall(`/orders/${testOrderId}/items/${firstItem.item_relation_id}`, 'PATCH', { quantity: firstItem.quantity + 1 });
                    log('‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ —É–≤–µ–ª–∏—á–µ–Ω–æ');
                }
                
                log('\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–ª–Ω–æ–º —Ç–µ—Å—Ç–µ: ${error.message}`);
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ID –∑–∞–∫–∞–∑–æ–≤
        document.getElementById('orderId').addEventListener('input', function() {
            document.getElementById('statusOrderId').value = this.value;
            document.getElementById('quantityOrderId').value = this.value;
        });
    </script>
</body>
</html>
