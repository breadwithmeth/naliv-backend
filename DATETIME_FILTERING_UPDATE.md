# Обновление фильтрации по дате и времени + удаление зависимости от order_history

## Обзор изменений

Система отчетов по курьерам была обновлена с двумя важными изменениями:

1. **Поддержка фильтрации по времени** - теперь можно получать отчеты с точностью до минут и секунд
2. **Удаление зависимости от таблицы order_history** - упрощение SQL запросов и повышение производительности

## Поддерживаемые форматы даты и времени

### 1. Только дата (YYYY-MM-DD)
```
start_date=2025-08-01
end_date=2025-08-10
```
- Для `start_date` время автоматически устанавливается на `00:00:00`
- Для `end_date` время автоматически устанавливается на `23:59:59`

### 2. Дата с часами и минутами (YYYY-MM-DD HH:mm)
```
start_date=2025-08-01 09:00
end_date=2025-08-01 18:00
```
- Секунды автоматически устанавливаются на `00`

### 3. Полное время (YYYY-MM-DD HH:mm:ss)
```
start_date=2025-08-01 09:30:00
end_date=2025-08-01 17:45:30
```
- Точное время с секундами

### 4. ISO 8601 формат
```
start_date=2025-08-01T09:30:00
end_date=2025-08-01T17:45:30Z
```
- Поддержка стандартного ISO формата с временными зонами

## Затронутые эндпоинты

### 1. Общий отчет по курьерам
```http
GET /api/businesses/reports/couriers?start_date=2025-08-01 09:00&end_date=2025-08-01 18:00
```

### 2. Детальный отчет по курьеру
```http
GET /api/businesses/reports/courier/5?start_date=2025-08-01 09:30:00&end_date=2025-08-01 17:45:30
```

## Примеры использования

### Рабочая смена курьера (9:00 - 18:00)
```
GET /api/businesses/reports/couriers?start_date=2025-08-01 09:00&end_date=2025-08-01 18:00
```

### Обеденный пик (12:00 - 14:00)
```
GET /api/businesses/reports/courier/5?start_date=2025-08-01 12:00:00&end_date=2025-08-01 14:00:00
```

### Ночная смена
```
GET /api/businesses/reports/couriers?start_date=2025-08-01 22:00&end_date=2025-08-02 06:00
```

## Технические детали

### Удаление зависимости от order_history
- Убраны JOIN'ы с таблицей `order_history` из SQL запросов
- Поля `taken_at`, `delivered_at`, `delivery_time_minutes` больше не возвращаются в API
- Среднее время доставки теперь является приблизительной оценкой (45 минут)
- Даты первой и последней доставки теперь берутся из поля `log_timestamp` таблицы `orders`

### Валидация
- Добавлена новая функция `validateAndParseDate()` для обработки различных форматов
- Автоматическое определение формата даты/времени
- Умная установка времени для дат без времени

### Обратная совместимость
- Старые запросы с форматом `YYYY-MM-DD` продолжают работать
- Поведение по умолчанию не изменилось

### Обновления в тестовом интерфейсе
- Поля ввода изменены на `datetime-local` для удобства
- Добавлены подсказки о поддерживаемых форматах
- Автоматическая конвертация значений в правильный формат

## Бэкворд совместимость

Все существующие интеграции продолжат работать без изменений. Формат `YYYY-MM-DD` полностью поддерживается и работает как прежде.

## Преимущества

1. **Точная фильтрация** - возможность получать отчеты за конкретные часы
2. **Гибкость** - поддержка различных форматов времени
3. **Аналитика смен** - анализ работы курьеров по часам
4. **Пиковые нагрузки** - изучение активности в определенное время

## Пример SQL запроса

Внутренне система теперь использует точные timestamp'ы:

```sql
WHERE o.log_timestamp BETWEEN '2025-08-01 09:00:00' AND '2025-08-01 18:00:00'
```

Вместо диапазона на весь день:

```sql
WHERE o.log_timestamp BETWEEN '2025-08-01 00:00:00' AND '2025-08-01 23:59:59'
```
