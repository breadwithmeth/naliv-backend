<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест интеграции Halyk Bank - Добавление карты</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin: 10px 0;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            background-color: #cce7ff;
            color: #004085;
            padding: 15px;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .cards-list {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .card-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logs {
            margin-top: 20px;
            padding: 15px;
            background-color: #f1f1f1;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тест интеграции Halyk Bank</h1>
        <p>Добавление банковской карты через API</p>

        <!-- Конфигурация -->
        <div class="form-group">
            <label for="apiBaseUrl">API Base URL:</label>
            <input type="text" id="apiBaseUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
        </div>

        <div class="form-group">
            <label for="authToken">JWT Token:</label>
            <input type="text" id="authToken" placeholder="Вставьте JWT токен здесь">
        </div>

        <!-- Информация -->
        <div class="info">
            <strong>Информация о процессе:</strong><br>
            • Для сохранения карты будет произведена верификация на сумму 0 ₸<br>
            • Деньги не списываются с карты<br>
            • Токен действует 20 минут<br>
            • При ошибке timeout происходит автоматическое обновление
        </div>

        <!-- Статус -->
        <div id="status"></div>

        <!-- Кнопки управления -->
        <div>
            <button class="button" onclick="initCardSave()" id="initBtn">
                Добавить карту
            </button>
            <button class="button" onclick="refreshInit()" id="refreshBtn" style="display: none;">
                Обновить токен
            </button>
            <button class="button" onclick="loadCards()">
                Загрузить список карт
            </button>
            <button class="button" onclick="clearLogs()">
                Очистить логи
            </button>
        </div>

        <!-- Список карт -->
        <div class="cards-list">
            <h3>Сохраненные карты:</h3>
            <div id="cardsList">
                <p>Карты не загружены</p>
            </div>
        </div>

        <!-- Логи -->
        <div class="logs">
            <h3>Логи операций:</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let currentInvoiceId = null;
        let halykScriptLoaded = false;

        // Функция логирования
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Функция показа статуса
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.innerHTML = message;
        }

        // Функция очистки логов
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Получение конфигурации
        function getConfig() {
            return {
                apiBaseUrl: document.getElementById('apiBaseUrl').value,
                authToken: document.getElementById('authToken').value
            };
        }

        // Загрузка скрипта Halyk Bank
        async function loadHalykScript(url) {
            if (halykScriptLoaded) {
                log('Скрипт Halyk Bank уже загружен');
                return;
            }

            return new Promise((resolve, reject) => {
                log(`Загрузка скрипта: ${url}`);
                const script = document.createElement('script');
                script.src = url;
                script.onload = () => {
                    halykScriptLoaded = true;
                    log('Скрипт Halyk Bank загружен успешно', 'success');
                    resolve();
                };
                script.onerror = () => {
                    log('Ошибка загрузки скрипта Halyk Bank', 'error');
                    reject(new Error('Failed to load Halyk script'));
                };
                document.head.appendChild(script);
            });
        }

        // Настройка callback'ов Halyk Bank
        function setupHalykCallbacks(invoiceId) {
            log('Настройка callback функций Halyk Bank');

            window.halykPaymentSuccess = (result) => {
                log(`Платеж успешен: ${JSON.stringify(result)}`, 'success');
                showStatus('Карта успешно добавлена!', 'success');
                document.getElementById('initBtn').disabled = false;
                loadCards();
            };

            window.halykPaymentError = (error) => {
                log(`Ошибка платежа: ${JSON.stringify(error)}`, 'error');
                handlePaymentError(invoiceId, error.code, error.message);
            };

            window.halykPaymentCancel = () => {
                log('Платеж отменен пользователем');
                showStatus('Операция отменена пользователем', 'error');
                document.getElementById('initBtn').disabled = false;
                document.getElementById('refreshBtn').style.display = 'none';
            };

            window.halykPaymentTimeout = () => {
                log('Время платежа истекло');
                handlePaymentError(invoiceId, 'timeout', 'Время сеанса истекло');
            };
        }

        // Обработка ошибок платежа
        async function handlePaymentError(invoiceId, error, errorMessage) {
            const config = getConfig();
            
            try {
                log(`Обработка ошибки: ${error} - ${errorMessage}`);
                
                const response = await fetch(`${config.apiBaseUrl}/api/payments/status`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ invoiceId, error, errorMessage })
                });

                const statusData = await response.json();
                log(`Ответ сервера: ${JSON.stringify(statusData)}`);

                if (statusData.success) {
                    const { userMessage, recommendation, canRetry } = statusData.data;
                    showStatus(userMessage, 'error');
                    
                    document.getElementById('initBtn').disabled = false;
                    
                    if (recommendation === 'refresh_token' && canRetry) {
                        document.getElementById('refreshBtn').style.display = 'inline-block';
                        log('Автоматическое обновление токена через 3 секунды...');
                        setTimeout(() => {
                            refreshInit();
                        }, 3000);
                    }
                }
            } catch (err) {
                log(`Ошибка обработки статуса: ${err.message}`, 'error');
                showStatus('Произошла неизвестная ошибка', 'error');
                document.getElementById('initBtn').disabled = false;
            }
        }

        // Инициализация сохранения карты
        async function initCardSave() {
            const config = getConfig();
            
            if (!config.authToken) {
                showStatus('Необходимо указать JWT токен', 'error');
                return;
            }

            try {
                document.getElementById('initBtn').disabled = true;
                document.getElementById('refreshBtn').style.display = 'none';
                showStatus('Инициализация сохранения карты...', 'loading');
                log('Начало инициализации сохранения карты');

                const baseUrl = window.location.origin;
                const requestBody = {
                    backLink: `${baseUrl}/success.html`,
                    failureBackLink: `${baseUrl}/failure.html`,
                    postLink: `${config.apiBaseUrl}/api/payments/save-card/postlink`,
                    description: 'Тестовая регистрация карты',
                    language: 'rus'
                };

                log(`Отправка запроса: ${JSON.stringify(requestBody)}`);

                const response = await fetch(`${config.apiBaseUrl}/api/payments/save-card/init`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                log(`Ответ сервера: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    currentInvoiceId = data.data.invoiceId;
                    await loadHalykScript(data.data.jsLibraryUrl);
                    setupHalykCallbacks(currentInvoiceId);
                    
                    log('Запуск формы оплаты Halyk Bank');
                    showStatus('Открытие формы ввода карты...', 'loading');
                    
                    window.halyk.pay(data.data.paymentObject);
                } else {
                    throw new Error(data.message || 'Неизвестная ошибка');
                }
            } catch (error) {
                log(`Ошибка инициализации: ${error.message}`, 'error');
                showStatus(`Ошибка: ${error.message}`, 'error');
                document.getElementById('initBtn').disabled = false;
            }
        }

        // Обновление токена
        async function refreshInit() {
            const config = getConfig();
            
            try {
                document.getElementById('refreshBtn').style.display = 'none';
                showStatus('Обновление токена...', 'loading');
                log('Обновление токена доступа');

                const baseUrl = window.location.origin;
                const requestBody = {
                    backLink: `${baseUrl}/success.html`,
                    failureBackLink: `${baseUrl}/failure.html`,
                    postLink: `${config.apiBaseUrl}/api/payments/save-card/postlink`,
                    description: 'Тестовая регистрация карты (обновлено)',
                    language: 'rus'
                };

                const response = await fetch(`${config.apiBaseUrl}/api/payments/save-card/refresh-init`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                log(`Токен обновлен: ${JSON.stringify(data, null, 2)}`);

                if (data.success && data.data.refreshed) {
                    currentInvoiceId = data.data.invoiceId;
                    setupHalykCallbacks(currentInvoiceId);
                    
                    log('Запуск формы оплаты с обновленным токеном');
                    showStatus('Открытие формы с новым токеном...', 'loading');
                    
                    window.halyk.pay(data.data.paymentObject);
                } else {
                    throw new Error(data.message || 'Ошибка обновления токена');
                }
            } catch (error) {
                log(`Ошибка обновления токена: ${error.message}`, 'error');
                showStatus(`Ошибка: ${error.message}`, 'error');
                document.getElementById('initBtn').disabled = false;
            }
        }

        // Загрузка списка карт
        async function loadCards() {
            const config = getConfig();
            
            if (!config.authToken) {
                return;
            }

            try {
                log('Загрузка списка сохраненных карт');
                
                const response = await fetch(`${config.apiBaseUrl}/api/user/cards`, {
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`
                    }
                });

                const data = await response.json();
                log(`Список карт: ${JSON.stringify(data)}`);

                const cardsDiv = document.getElementById('cardsList');
                
                if (data.success && data.data.cards.length > 0) {
                    cardsDiv.innerHTML = data.data.cards.map(card => 
                        `<div class="card-item">
                            <span>${card.mask}</span>
                            <button class="button" onclick="deleteCard(${card.card_id})" style="background-color: #dc3545;">
                                Удалить
                            </button>
                        </div>`
                    ).join('');
                } else {
                    cardsDiv.innerHTML = '<p>Сохраненных карт нет</p>';
                }
            } catch (error) {
                log(`Ошибка загрузки карт: ${error.message}`, 'error');
            }
        }

        // Удаление карты
        async function deleteCard(cardId) {
            const config = getConfig();
            
            if (!confirm('Удалить эту карту?')) {
                return;
            }

            try {
                log(`Удаление карты с ID: ${cardId}`);
                
                const response = await fetch(`${config.apiBaseUrl}/api/user/cards/${cardId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`
                    }
                });

                const data = await response.json();
                log(`Результат удаления: ${JSON.stringify(data)}`);

                if (data.success) {
                    log('Карта успешно удалена', 'success');
                    loadCards();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                log(`Ошибка удаления карты: ${error.message}`, 'error');
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            log('Страница загружена, готов к работе');
            
            // Загружаем токен из localStorage если есть
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                document.getElementById('authToken').value = savedToken;
                loadCards();
            }

            // Сохраняем токен при изменении
            document.getElementById('authToken').addEventListener('input', function() {
                localStorage.setItem('authToken', this.value);
            });
        });
    </script>
</body>
</html>
