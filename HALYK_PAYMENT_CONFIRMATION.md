# Автоматическое подтверждение платежей Halyk Bank

## Описание

При смене статуса заказа на "Готов к выдаче" (статус 2) система автоматически:
1. Пересчитывает финальную стоимость заказа **с учетом всех акций и скидок** (используя OrderController)
2. Подтверждает операцию в Halyk Bank (частичное или полное списание)
3. Списывает только необходимую сумму с учетом скидок и бонусов

## Техническая реализация

### Расчет стоимости заказа

Система использует `OrderController.calculateOrderCostPublic()` который учитывает:
- **Акции типа SUBTRACT**: "купи 2 получи 1 бесплатно"
- **Акции типа DISCOUNT**: процентные скидки
- **Стоимость опций**: дополнительные товары к основным позициям
- **Маркетинговые промоции**: из таблицы `marketing_promotion_details`

### API Halyk Bank для подтверждения операций

**URL для подтверждения:**
- TEST: `POST https://testepay.homebank.kz/api/operation/:id/charge`
- PROD: `POST https://epay-api.homebank.kz/operation/:id/charge`

**Параметры:**
- `amount` (опциональный) - сумма для частичного списания
- Если amount не указан, списывается полная сумма операции

### Процесс работы

1. **Обновление статуса заказа** (PATCH `/api/business/orders/:id/status`)
   - При установке статуса 2 запускается `recalculateOrderCostAndConfirmPayment()`

2. **Пересчет стоимости заказа:**
   ```typescript
   // Используем точный расчет из OrderController с учетом акций
   const orderTotals = await OrderController.calculateOrderCostPublic(orderId);
   const finalAmount = orderTotals.sum_before_delivery + deliveryPrice + serviceFee - bonusUsed;
   ```

3. **Подтверждение операции в Halyk Bank:**
   - Получение токена авторизации
   - Отправка запроса на подтверждение с финальной суммой
   - Логирование результата в поле `extra` заказа

4. **Обработка результата:**
   - Успех: сохранение информации о подтвержденном платеже
   - Ошибка: логирование ошибки и установка статуса 6

### Структура данных в поле `extra`

```json
{
  "confirmed_payment": {
    "amount": 2450,
    "confirmed_at": "2024-08-06T10:30:00.000Z",
    "halyk_response": {
      "code": "ok",
      "reference": "ref123",
      "approvalCode": "approval456"
    },
    "calculation_details": {
      "items_cost": 2000,
      "delivery_price": 500,
      "service_fee": 100,
      "bonus_used": 150,
      "order_totals": {
        "sum_before_delivery": 2000,
        "total_sum": 2500
      }
    }
  }
}
```

### Переменные окружения

Учетные данные Halyk Bank встроены в код (используются те же, что и в OrderController):
- `client_id: 'NALIV.KZ'`
- `client_secret: 'B5Y56*Hw9hxcvwwY'`
- `auth: '050052bf-1761-11ee-8376-088fc3787894'`

Дополнительная настройка переменных окружения не требуется.

### Новые методы в BusinessOrderController

1. `getHalykToken()` - получение токена авторизации
2. `confirmHalykOperation(operationId, amount?)` - подтверждение операции
3. `recalculateOrderCostAndConfirmPayment(orderId)` - основная логика с OrderController
4. `recalculateOrderCost(orderId)` - простой пересчет через OrderController

### Новые методы в OrderController

1. `calculateOrderCostPublic(orderId)` - публичный метод для расчета стоимости с учетом акций

### Преимущества использования OrderController

- ✅ **Точный расчет**: учитываются все типы акций и скидок
- ✅ **Консистентность**: один алгоритм расчета во всей системе
- ✅ **Промоции**: автоматический учет маркетинговых акций
- ✅ **Опции**: правильный расчет дополнительных товаров
- ✅ **Остатки**: корректная обработка количества товаров

### Требования

- Заказ должен иметь `payment_id` (созданный ранее через Halyk Bank API)
- Настроенные учетные данные Halyk Bank
- Операция должна быть в статусе "Auth" в системе Halyk Bank

### Тестирование

Используйте файл `test-order-status-recalculation.html` для проверки:
1. Получение текущего статуса заказа
2. Установка статуса 2 с автоматическим подтверждением платежа
3. Проверка результата операции и детализации расчета

### Логи

Система логирует:
- Процесс пересчета стоимости через OrderController
- Детали применения акций и скидок
- Запросы к Halyk Bank API
- Результаты подтверждения операций
- Ошибки платежных операций

### Безопасность

- Токены Halyk Bank обновляются автоматически для каждого запроса
- Ошибки платежей не блокируют смену статуса заказа
- Вся информация о платежах логируется для аудита
- Детализация расчетов сохраняется в поле `extra`
