<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Invoice ID</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        .invoice-display {
            font-weight: bold;
            font-size: 1.2em;
            color: #007bff;
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Invoice ID</h1>
        
        <div class="test-section">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ</h3>
            <ul>
                <li><strong>–§–æ—Ä–º–∞—Ç:</strong> CARD{timestamp}{userID}{random}{refresh}</li>
                <li><strong>–î–ª–∏–Ω–∞:</strong> –ú–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤</li>
                <li><strong>–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:</strong> –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î (orders + halyk_saved_cards)</li>
                <li><strong>–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏:</strong> –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 10–º—Å</li>
                <li><strong>Fallback:</strong> UUID –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>–¢–µ—Å—Ç 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã</h3>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é invoiceId –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã</p>
            <button onclick="testInitCardSave()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</button>
            <div id="initResult" class="log"></div>
            <div id="initInvoiceId" class="invoice-display" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>–¢–µ—Å—Ç 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã</h3>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é invoiceId –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (refresh=true)</p>
            <button onclick="testRefreshCardSave()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
            <div id="refreshResult" class="log"></div>
            <div id="refreshInvoiceId" class="invoice-display" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>–¢–µ—Å—Ç 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</h3>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö</p>
            <button onclick="testMultipleGeneration()">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 5 invoiceId</button>
            <div id="multipleResult" class="log"></div>
        </div>

        <div class="test-section">
            <h3>–¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Halyk Bank</h3>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–∏ Halyk Bank –Ω–æ–≤—ã–µ invoiceId</p>
            <button onclick="testHalykCompatibility()">–¢–µ—Å—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏</button>
            <div id="halykResult" class="log"></div>
        </div>

        <div class="test-section">
            <h3>–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞</h3>
            <div id="serverLogs" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const testUserId = 39102; // –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function displayInvoiceId(elementId, invoiceId) {
            const element = document.getElementById(elementId);
            element.textContent = `Generated Invoice ID: ${invoiceId}`;
            element.style.display = 'block';
        }

        async function makeRequest(endpoint, options = {}) {
            const token = 'test-token'; // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            return fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
        }

        async function testInitCardSave() {
            log('initResult', '–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã...');
            
            try {
                const response = await makeRequest('/payments/save-card/init', {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: testUserId,
                        description: '–¢–µ—Å—Ç –Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ invoiceId'
                    })
                });

                const data = await response.json();
                log('initResult', `–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data, null, 2)}`, 'info');

                if (data.success) {
                    const invoiceId = data.data.invoiceId;
                    displayInvoiceId('initInvoiceId', invoiceId);
                    log('initResult', `‚úÖ Invoice ID —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${invoiceId}`, 'success');
                    
                    // –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞
                    analyzeInvoiceId('initResult', invoiceId, false);
                } else {
                    log('initResult', `‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
                }
            } catch (error) {
                log('initResult', `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function testRefreshCardSave() {
            log('refreshResult', '–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã...');
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const initResponse = await makeRequest('/payments/save-card/init', {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: testUserId,
                        description: '–ö–∞—Ä—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'
                    })
                });

                const initData = await initResponse.json();
                if (!initData.success) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è —Ç–µ—Å—Ç–∞');
                }

                const originalInvoiceId = initData.data.invoiceId;
                log('refreshResult', `–°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–∞ —Å invoiceId: ${originalInvoiceId}`);

                // –¢–µ–ø–µ—Ä—å —Ç–µ—Å—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                const refreshResponse = await makeRequest('/payments/save-card/refresh', {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: testUserId,
                        originalInvoiceId: originalInvoiceId
                    })
                });

                const refreshData = await refreshResponse.json();
                log('refreshResult', `–û—Ç–≤–µ—Ç –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${JSON.stringify(refreshData, null, 2)}`, 'info');

                if (refreshData.success) {
                    const newInvoiceId = refreshData.data.invoiceId;
                    displayInvoiceId('refreshInvoiceId', newInvoiceId);
                    log('refreshResult', `‚úÖ –ù–æ–≤—ã–π Invoice ID: ${newInvoiceId}`, 'success');
                    
                    // –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞
                    analyzeInvoiceId('refreshResult', newInvoiceId, true);
                } else {
                    log('refreshResult', `‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${refreshData.message}`, 'error');
                }
            } catch (error) {
                log('refreshResult', `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
            }
        }

        async function testMultipleGeneration() {
            log('multipleResult', '–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...');
            const invoiceIds = [];

            for (let i = 1; i <= 5; i++) {
                try {
                    log('multipleResult', `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ${i}/5...`);
                    
                    const response = await makeRequest('/payments/save-card/init', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: testUserId,
                            description: `–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ #${i}`
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        const invoiceId = data.data.invoiceId;
                        invoiceIds.push(invoiceId);
                        log('multipleResult', `${i}. ${invoiceId}`, 'success');
                    } else {
                        log('multipleResult', `${i}. –û—à–∏–±–∫–∞: ${data.message}`, 'error');
                    }

                    // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    log('multipleResult', `${i}. –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
            const uniqueIds = [...new Set(invoiceIds)];
            log('multipleResult', `\n--- –ê–Ω–∞–ª–∏–∑ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ ---`);
            log('multipleResult', `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${invoiceIds.length}`);
            log('multipleResult', `–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: ${uniqueIds.length}`);
            
            if (invoiceIds.length === uniqueIds.length) {
                log('multipleResult', `‚úÖ –í—Å–µ Invoice ID —É–Ω–∏–∫–∞–ª—å–Ω—ã!`, 'success');
            } else {
                log('multipleResult', `‚ùå –ù–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã!`, 'error');
                const duplicates = invoiceIds.filter((id, index) => invoiceIds.indexOf(id) !== index);
                log('multipleResult', `–î—É–±–ª–∏–∫–∞—Ç—ã: ${duplicates.join(', ')}`, 'error');
            }
        }

        async function testHalykCompatibility() {
            log('halykResult', '–¢–µ—Å—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Halyk Bank API...');
            
            try {
                const response = await makeRequest('/payments/save-card/init', {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: testUserId,
                        description: '–¢–µ—Å—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Halyk Bank'
                    })
                });

                const data = await response.json();
                log('halykResult', `–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data, null, 2)}`, 'info');

                if (data.success && data.data.halykResponse) {
                    log('halykResult', `‚úÖ Halyk Bank –ø—Ä–∏–Ω—è–ª –Ω–æ–≤—ã–π invoiceId!`, 'success');
                    log('halykResult', `Token –ø–æ–ª—É—á–µ–Ω: ${data.data.halykResponse.access_token ? '–î–∞' : '–ù–µ—Ç'}`, 'success');
                    log('halykResult', `Expires in: ${data.data.halykResponse.expires_in} —Å–µ–∫—É–Ω–¥`, 'info');
                } else {
                    log('halykResult', `‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –æ—Ç Halyk Bank`, 'error');
                }
            } catch (error) {
                log('halykResult', `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
            }
        }

        function analyzeInvoiceId(logElementId, invoiceId, isRefresh) {
            log(logElementId, `\n--- –ê–Ω–∞–ª–∏–∑ Invoice ID ---`);
            log(logElementId, `ID: ${invoiceId}`);
            log(logElementId, `–î–ª–∏–Ω–∞: ${invoiceId.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            log(logElementId, `–ü—Ä–µ—Ñ–∏–∫—Å: ${invoiceId.startsWith('CARD') ? '‚úÖ CARD' : '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å'}`);
            log(logElementId, `Refresh —Ñ–ª–∞–≥: ${isRefresh ? '–û–∂–∏–¥–∞–µ—Ç—Å—è 1' : '–û–∂–∏–¥–∞–µ—Ç—Å—è 0'}`);
            
            if (invoiceId.length <= 20) {
                log(logElementId, `‚úÖ –î–ª–∏–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º Halyk Bank`, 'success');
            } else {
                log(logElementId, `‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ (20 —Å–∏–º–≤–æ–ª–æ–≤)`, 'error');
            }

            // –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            if (invoiceId.startsWith('CARD') && invoiceId.length >= 8) {
                const withoutPrefix = invoiceId.substring(4);
                log(logElementId, `–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ—Å–ª–µ CARD: ${withoutPrefix}`);
                
                // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª - refresh —Ñ–ª–∞–≥
                const refreshFlag = withoutPrefix.slice(-1);
                log(logElementId, `Refresh —Ñ–ª–∞–≥ –≤ ID: ${refreshFlag} ${refreshFlag === (isRefresh ? '1' : '0') ? '‚úÖ' : '‚ùå'}`);
            }
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        setInterval(() => {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            const now = new Date().toLocaleTimeString();
            if (document.getElementById('serverLogs').innerHTML === '') {
                log('serverLogs', `–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω. –õ–æ–≥–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.`);
            }
        }, 5000);
    </script>
</body>
</html>
