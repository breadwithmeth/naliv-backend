<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Order Creation with Payment</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .output { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; min-height: 100px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –æ–ø–ª–∞—Ç–æ–π</h1>
    
    <form id="orderForm">
        <div class="form-group">
            <label for="business_id">ID –ë–∏–∑–Ω–µ—Å–∞:</label>
            <input type="number" id="business_id" name="business_id" value="1" required>
        </div>

        <div class="form-group">
            <label for="address_id">ID –ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <input type="number" id="address_id" name="address_id" value="42">
        </div>

        <div class="form-group">
            <label for="delivery_type">–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <select id="delivery_type" name="delivery_type" required>
                <option value="DELIVERY">–î–æ—Å—Ç–∞–≤–∫–∞</option>
                <option value="PICKUP">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
                <option value="SCHEDULED">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</option>
            </select>
        </div>

        <div class="form-group">
            <label for="items">–¢–æ–≤–∞—Ä—ã (JSON):</label>
            <textarea id="items" name="items" rows="6" required>[
  {
    "item_id": 1,
    "amount": 2,
    "options": []
  },
  {
    "item_id": 2,
    "amount": 1,
    "options": []
  }
]</textarea>
        </div>

        <div class="form-group">
            <label for="payment_method">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã:</label>
            <select id="payment_method" name="payment_method">
                <option value="card">–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                <option value="saved_card">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
            </select>
        </div>

        <div class="form-group">
            <label for="saved_card_id">ID –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –º–µ—Ç–æ–¥ 'saved_card'):</label>
            <input type="number" id="saved_card_id" name="saved_card_id">
        </div>

        <div class="form-group">
            <label for="bonus">–ë–æ–Ω—É—Å—ã:</label>
            <input type="number" id="bonus" name="bonus" value="0">
        </div>

        <button type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –æ–ø–ª–∞—Ç–æ–π</button>
    </form>

    <div class="form-group" style="margin-top: 30px;">
        <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞</h3>
        <label for="order_id_check">ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</label>
        <input type="number" id="order_id_check" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞">
        <button type="button" onclick="checkOrderStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>

    <div class="output" id="output">
        –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç...
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyNTIsInVzZXJuYW1lIjoic2hydiIsImVtYWlsIjoic2hydk5hbGl2QGdtYWlsLmNvbSIsImlhdCI6MTczNzk5MTA1NSwiZXhwIjoxNzM3OTk0NjU1fQ.LhCYSfhcLGIeHGU5w_fwM3j0bVrGM-IHhzK6EWuP0QY'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
            console.log(message);
        }

        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // –û—á–∏—â–∞–µ–º –≤—ã–≤–æ–¥
            document.getElementById('output').innerHTML = '';
            
            try {
                log('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –æ–ø–ª–∞—Ç–æ–π...', 'info');
                
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                const formData = new FormData(this);
                const data = {};
                
                for (let [key, value] of formData.entries()) {
                    if (key === 'items') {
                        try {
                            data[key] = JSON.parse(value);
                        } catch (e) {
                            throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤');
                        }
                    } else if (key === 'business_id' || key === 'address_id' || key === 'bonus' || key === 'saved_card_id') {
                        data[key] = value ? parseInt(value) : undefined;
                    } else {
                        data[key] = value || undefined;
                    }
                }

                // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
                Object.keys(data).forEach(key => {
                    if (data[key] === undefined || data[key] === '') {
                        delete data[key];
                    }
                });

                log(`–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(data, null, 2)}`, 'info');

                const response = await fetch(`${API_BASE_URL}/api/payments/create-order-with-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.headers.get('content-type')?.includes('text/html')) {
                    log('‚úÖ –ü–æ–ª—É—á–µ–Ω HTML –æ—Ç–≤–µ—Ç —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º–æ–π!', 'success');
                    const html = await response.text();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º
                    log(`HTML —Å–æ–¥–µ—Ä–∂–∏—Ç Halyk –±–∏–±–ª–∏–æ—Ç–µ–∫—É: ${html.includes('payment-api.js') ? '–î–∞' : '–ù–µ—Ç'}`, 'info');
                    log(`HTML —Å–æ–¥–µ—Ä–∂–∏—Ç halyk.pay: ${html.includes('halyk.pay') ? '–î–∞' : '–ù–µ—Ç'}`, 'info');
                    log(`HTML —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–∫–µ–Ω auth: ${html.includes('"access_token"') ? '–î–∞' : '–ù–µ—Ç'}`, 'info');
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ –∏–∑ HTML
                    const orderMatch = html.match(/–ó–∞–∫–∞–∑ ‚Ññ(ORDER-[^"]+)/);
                    const amountMatch = html.match(/–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: (\d+(?:\.\d+)?)/);
                    
                    if (orderMatch) {
                        log(`üì¶ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${orderMatch[1]}`, 'success');
                    }
                    if (amountMatch) {
                        log(`üí∞ –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: ${amountMatch[1]} ‚Ç∏`, 'success');
                    }
                    
                    // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                    const openPayment = confirm('–û—Ç–∫—Ä—ã—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Ñ–æ—Ä–º—É –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ?');
                    if (openPayment) {
                        const newWindow = window.open('', '_blank');
                        newWindow.document.write(html);
                        log('üöÄ –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ', 'success');
                    }
                    
                } else {
                    const result = await response.json();
                    if (result.success) {
                        log('‚úÖ ' + JSON.stringify(result, null, 2), 'success');
                    } else {
                        log('‚ùå ' + JSON.stringify(result, null, 2), 'error');
                    }
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });

        async function checkOrderStatus() {
            const orderId = document.getElementById('order_id_check').value;
            if (!orderId) {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞', 'error');
                return;
            }

            try {
                log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ ${orderId}...`, 'info');

                const response = await fetch(`${API_BASE_URL}/api/payments/order-payment-status/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    log('‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ–ª—É—á–µ–Ω:', 'success');
                    log(`üì¶ –ó–∞–∫–∞–∑: ${result.data.order.order_uuid}`, 'info');
                    log(`üìä –°—Ç–∞—Ç—É—Å: ${result.data.order.status}`, 'info');
                    log(`üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${result.data.cost?.total} ‚Ç∏`, 'info');
                    log(`üöö –î–æ—Å—Ç–∞–≤–∫–∞: ${result.data.cost?.delivery} ‚Ç∏`, 'info');
                    log(`üí≥ –¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏: ${result.data.order.delivery_type}`, 'info');
                    
                    if (result.data.payment) {
                        log(`üîó Invoice ID: ${result.data.payment.payment_invoice_id}`, 'info');
                        log(`üí≥ –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã: ${result.data.payment.payment_method}`, 'info');
                    }
                } else {
                    log('‚ùå ' + JSON.stringify(result, null, 2), 'error');
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'error');
            }
        }

        log('–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –æ–ø–ª–∞—Ç–æ–π', 'info');
    </script>
</body>
</html>
