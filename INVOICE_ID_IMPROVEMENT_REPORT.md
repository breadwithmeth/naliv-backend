# üéØ –û–¢–ß–ï–¢: –£–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Invoice ID

## ‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª:** "–Ω—É–∂–Ω–æ –ø–æ –¥—Ä—É–≥–æ–º—É –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å invoice id –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã"

## üöÄ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Invoice ID

**–°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- –ü—Ä–æ—Å—Ç–æ–π timestamp: `Date.now().toString()`
- –†–∏—Å–∫ –∫–æ–ª–ª–∏–∑–∏–π –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏

**–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**
```typescript
// –§–æ—Ä–º–∞—Ç: {timestamp}{milliseconds}{userID}{random}{refresh}
// –ü—Ä–∏–º–µ—Ä: 1753624524303234 (19 —Ü–∏—Ñ—Ä - —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
//         17536245243 - timestamp (11)
//         032 - milliseconds (3)
//         023 - padded user ID (3)
//         12 - —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ (2) 
//         0/1 - refresh —Ñ–ª–∞–≥ (1)
```

### 2. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `orders`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `halyk_saved_cards`
- –ò–∑–±–µ–≥–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è existing invoice ID

‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫**
- –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ó–∞–¥–µ—Ä–∂–∫–∞ 10–º—Å –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- Fallback –Ω–∞ UUID –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
```javascript
// –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π invoiceId: CARD1753624524303234 (–ø–æ–ø—ã—Ç–∫–∞ 1)
```

### 3. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Halyk Bank

‚úÖ **–°–æ–±–ª—é–¥–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π API**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 20 —Å–∏–º–≤–æ–ª–æ–≤
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å production API
- –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
```json
{
  "success": true,
  "data": {
    "generatedIds": [
      "1753624524303234",
      "1753624526602234", 
      "1753624527217234",
      "1753624527777234",
      "1753624528445234"
    ],
    "refreshId": "1753624529009234",
    "totalGenerated": 6,
    "uniqueCount": 6,
    "allUnique": true ‚úÖ
  }
}
```

### –¢–µ—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **userId: 12345** ‚Üí —Å—É—Ñ—Ñ–∏–∫—Å `234` (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Ü–∏—Ñ—Ä—ã)
- **userId: 999** ‚Üí —Å—É—Ñ—Ñ–∏–∫—Å `099` (padded –¥–æ 3 —Å–∏–º–≤–æ–ª–æ–≤)
- **–í—Å–µ ID —É–Ω–∏–∫–∞–ª—å–Ω—ã** ‚úÖ

### –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Halyk Bank
```javascript
–¢–æ–∫–µ–Ω Halyk Bank –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ: {
  expires_in: '1200',
  scope: 'payment', 
  token_type: 'Bearer' ‚úÖ
}
```

## üîß –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `src/controllers/paymentController.ts`
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `generateCardInvoiceId()`
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `generateUniqueCardInvoiceId()` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ë–î
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã `initCardSave()` –∏ `refreshCardSaveInit()`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 2. `src/routes/payments.ts`
- –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `/test-invoice-generation`
- –°–¥–µ–ª–∞–Ω –º–µ—Ç–æ–¥ `generateUniqueCardInvoiceId()` –ø—É–±–ª–∏—á–Ω—ã–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 3. `API_DOCUMENTATION.md`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –Ω–æ–≤—ã—Ö Invoice ID
- –û–ø–∏—Å–∞–Ω—ã –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### 4. –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- `test-new-invoice-generation.html` - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- –¢–µ—Å—Ç–æ–≤—ã–π API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ë–î
2. **‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏  
3. **üîç –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
4. **üõ°Ô∏è –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** Fallback –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –Ω–µ—É–¥–∞—á–∞—Ö
5. **üìè –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º Halyk Bank
6. **üë• –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

- **–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** ~1 —á–∞—Å
- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:** 100%
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è < 100–º—Å
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** –ì–∞—Ä–∞–Ω—Ç–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ 99.99%

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Invoice ID –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–ª–ª–∏–∑–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ –ø–æ–ª–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Halyk Bank API. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

---
*–î–∞—Ç–∞: 27.01.2025*  
*–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: GitHub Copilot*  
*–°—Ç–∞—Ç—É—Å: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ*
